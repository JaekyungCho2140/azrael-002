# Azrael PRD - Phase 3: ìŠ¬ë™ ë©”ì‹œì§€ ë°œì‹ 

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2026-02-08
**ë²„ì „**: 3.7 (8ì°¨ íŒ€ ë¦¬ë·° ë°˜ì˜)
**ì°¸ì¡°**: [Azrael-PRD-Master.md](./Azrael-PRD-Master.md) | [Azrael-PRD-Shared.md](./Azrael-PRD-Shared.md)

**Phase 3 Status**: ğŸ“ ì„¤ê³„ ì™„ë£Œ

---

## ë¬¸ì„œ ê°œìš”

Phase 3ëŠ” **ìŠ¬ë™ ë©”ì‹œì§€ ë°œì‹ ** ê¸°ëŠ¥ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

| ê¸°ëŠ¥ | í•µì‹¬ ê°€ì¹˜ |
|------|-----------|
| **ìŠ¬ë™ ë°œì‹ ** | íŒ€ ë‚´ë¶€ ì¼ì • ê³µìœ  ìë™í™” ë° ì¦‰ì‹œ í™•ì¸ (ìŠ¬ë™ í™•ì¸ìœ¨ 100%) |
| **ë©”ì‹œì§€ í…œí”Œë¦¿** | í”„ë¡œì íŠ¸ë³„ ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥í•œ ìŠ¬ë™ ë©”ì‹œì§€ í˜•ì‹ |
| **ìŠ¤ë ˆë“œ ë¦¬í”Œë¼ì´** | ê¸°ì¡´ ë©”ì‹œì§€ì— í›„ì† ì •ë³´ ì¶”ê°€ |

**ì „ì œì¡°ê±´**: Phase 0, 0.5, 1, 1.7, 1.8, 2 (ëª¨ë‘ ì™„ë£Œ)

---

## ë³´ì•ˆ ì •ì±…

> **ë‚´ë¶€ ë„êµ¬ ë³´ì•ˆ ì •ì±…**
>
> ë³¸ ì„œë¹„ìŠ¤ëŠ” ë‹¤ìŒ íŠ¹ì„±ì„ ê°€ì§€ë¯€ë¡œ, ì¼ë¶€ ë³´ì•ˆ í‘œì¤€ì„ ê°„ì†Œí™”í•©ë‹ˆë‹¤:
> - **ì‚¬ìš©ì**: ì´ 6ëª… (L10níŒ€ ë‚´ë¶€ + ì™¸ë¶€ 1ëª…)
> - **ê´€ë¦¬ì/ê°œë°œì**: ë™ì¼ì¸ (ì¬ê²½)
> - **ë°°í¬ ëª©ì **: íŒ€ ë‚´ë¶€ ì „ìš© ë„êµ¬ (ì™¸ë¶€ ë°°í¬ ì—†ìŒ)
>
> ë”°ë¼ì„œ:
> - OAuth Token: í‰ë¬¸ ì €ì¥ + RLS (Supabase Vault ë¯¸ì‚¬ìš©)
> - Token Rotation: ë¯¸ì‚¬ìš© (ë¹„ë§Œë£Œ í† í°, refresh_token ë¶ˆí•„ìš”)
> - Edge Function: bodyì—ì„œ userId ì „ë‹¬ (JWT ê²€ì¦ ìƒëµ) â€” ê¸°ì¡´ JIRA Edge Functionê³¼ ë™ì¼ íŒ¨í„´
> - State ê²€ì¦: í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ (localStorage ë¹„êµ) â€” ì˜ë„ì  ê²°ì •
>
> **CSRF State í´ë¼ì´ì–¸íŠ¸ ê²€ì¦ ê·¼ê±°**: ì„œë²„ ì‚¬ì´ë“œ ê²€ì¦ì´ ë³´ì•ˆ í‘œì¤€ì´ë‚˜, ë‹¤ìŒ ì´ìœ ë¡œ í´ë¼ì´ì–¸íŠ¸ ì „ìš© ê²€ì¦ì„ ì±„íƒí•©ë‹ˆë‹¤:
> - Edge Functionì€ stateless (ì„¸ì…˜/Redis ì—†ìŒ) â†’ ì„œë²„ ê²€ì¦ ì‹œ DB ì™•ë³µ í•„ìš” (ë³µì¡ë„ ì¦ê°€)
> - OAuth ì½œë°±ì€ Slackâ†’Edge Functionâ†’íŒì—… ë¦¬ë‹¤ì´ë ‰íŠ¸ íë¦„ì´ë¯€ë¡œ, ê³µê²©ìê°€ CSRFë¥¼ ì„±ê³µí•˜ë ¤ë©´ í”¼í•´ì ë¸Œë¼ìš°ì €ì˜ localStorageì— ì ‘ê·¼í•´ì•¼ í•¨ (ì´ë¯¸ XSSê°€ í•„ìš”í•œ ìˆ˜ì¤€)
> - 6ëª… ë‚´ë¶€ ë„êµ¬ì´ë¯€ë¡œ ê³µê²© í‘œë©´ì´ ê·¹íˆ ì œí•œì 
> - ì¶”í›„ ì™¸ë¶€ ë°°í¬ ì‹œ ì„œë²„ ì‚¬ì´ë“œ ê²€ì¦ìœ¼ë¡œ ì „í™˜ í•„ìš” (DBì— state ì €ì¥ + Edge Functionì—ì„œ ë¹„êµ)
>
> ì´ ê²°ì •ì€ ê²€í†  ì™„ë£Œëœ ì‚¬í•­ì´ë©°, ì¶”í›„ ì™¸ë¶€ ë°°í¬ ì‹œ ì¬ê²€í†  í•„ìš”.

---

# 1. ê¸°ëŠ¥ ëª©ì 

ê³„ì‚°ëœ ì¼ì • í…Œì´ë¸”(T1/T2/T3)ì„ ê¸°ë°˜ìœ¼ë¡œ **ìŠ¬ë™ ì±„ë„ì— ë©”ì‹œì§€ë¥¼ ìë™ ë°œì‹ **í•©ë‹ˆë‹¤.

**ë°œì‹  ëŒ€ìƒ**:
- ë‚´ë¶€ ìœ ê´€ë¶€ì„œ: L10níŒ€ ì±„ë„, QA ì±„ë„ ë“±
- ì™¸ë¶€ í˜‘ë ¥ì—…ì²´: í˜‘ë ¥ì‚¬ ê³µìœ  ì±„ë„

**ì£¼ìš” ê°€ì¹˜**:
- ìŠ¬ë™ ë©”ì‹œì§€ ì‘ì„± ì‹œê°„ 95% ë‹¨ì¶• (ìˆ˜ë™ 5ë¶„ â†’ ìë™ 15ì´ˆ)
- íŒ€ì› ìŠ¬ë™ í™•ì¸ìœ¨ 100% (ì´ë©”ì¼ ëŒ€ë¹„ ë†’ì€ í™•ì¸ìœ¨)
- ì‚¬ìš©ì ê³„ì •ìœ¼ë¡œ ë°œì‹ í•˜ì—¬ ìì—°ìŠ¤ëŸ¬ìš´ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜
- ë©”ì‹œì§€ í…œí”Œë¦¿ìœ¼ë¡œ í”„ë¡œì íŠ¸ë³„ ë§ì¶¤ í˜•ì‹ ì§€ì›

---

# 2. ê¸°ëŠ¥ ìƒì„¸

## 2.1 ì…ë ¥/ì¶œë ¥

| í•­ëª© | ì„¤ëª… |
|------|------|
| **ì…ë ¥** | ì„ íƒí•œ í…Œì´ë¸” (T1, T2, ë˜ëŠ” T3) - í…Œì´ë¸” ëª…ì¹­ í‘œ ì°¸ê³  (Phase 2 Â§2.1) |
| **ì¶œë ¥** | ìŠ¬ë™ ì±„ë„ ë©”ì‹œì§€ (mrkdwn í˜•ì‹) |

## 2.2 ìŠ¬ë™ ë©”ì‹œì§€ ì˜ˆì‹œ (mrkdwn)

ì•„ë˜ëŠ” ê¸°ë³¸ ì œê³µ í…œí”Œë¦¿ì´ ë Œë”ë§ëœ ê²°ê³¼ ì˜ˆì‹œì…ë‹ˆë‹¤:

```
*[02-10 ì—…ë°ì´íŠ¸ ì¼ì •]*

*í—¤ì¦ˆì—…:* 01/28(í™”)
{{#if showIosReviewDate}}*iOS ì‹¬ì‚¬ì¼:* 02/03(ì›”){{/if}}
{{#if showPaidProductDate}}*ìœ ë£Œí™” ìƒí’ˆ í˜‘ì˜:* 01/20(ì›”){{/if}}

---

*[ì¼ì • ìš”ì•½]*
1. ì •ê¸°: 01/10(ê¸ˆ) 09:00 ~ 01/15(ìˆ˜) 18:00
2. 1ì°¨: 01/20(ì›”) 09:00 ~ 01/25(í† ) 18:00
3. 2ì°¨: 02/01(ì¼) 09:00 ~ 02/05(ëª©) 18:00

---

_{disclaimer}_

<https://azrael-002.vercel.app|Azraelì—ì„œ ìì„¸íˆ ë³´ê¸°>
```

> **ì°¸ê³ **: `{updateDateShort}` ì¶œë ¥ í˜•ì‹ì€ ê¸°ì¡´ `formatUpdateDateShort()` í•¨ìˆ˜ì™€ ë™ì¼í•œ `MM-DD` í˜•ì‹ì…ë‹ˆë‹¤ (ì˜ˆ: `02-10`). ì—°ë„ë¥¼ í¬í•¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
>
> **ë Œë”ë§ ì˜ˆì‹œì™€ ì‹¤ì œ í…œí”Œë¦¿ ì°¨ì´**: ìœ„ ì˜ˆì‹œëŠ” ë³€ìˆ˜(`{headsUp}` ë“±)ì™€ ì¡°ê±´ë¶€ ë¸”ë¡(`{{#if ...}}`)ì´ ìµœì¢… ë Œë”ë§ëœ ê²°ê³¼ì…ë‹ˆë‹¤. ì‹¤ì œ ì €ì¥ë˜ëŠ” ê¸°ë³¸ ì œê³µ í…œí”Œë¦¿ ì›ë³¸ì€ Â§6.1 "ê¸°ë³¸ ì œê³µ í…œí”Œë¦¿ (built-in)" ì„¹ì…˜ì„ ì°¸ì¡°í•˜ì„¸ìš”.

## 2.3 Disclaimer ìŠ¬ë™ ë³€í™˜ ê·œì¹™

ì»¤ìŠ¤í…€ ì„œì‹ íƒœê·¸ë¥¼ ìŠ¬ë™ mrkdwnìœ¼ë¡œ ë³€í™˜:

| ì»¤ìŠ¤í…€ íƒœê·¸ | ìŠ¬ë™ mrkdwn | ë¹„ê³  |
|------------|------------|------|
| `<b>text</b>` | `*text*` | Bold |
| `<r>text</r>` | `text` | ìƒ‰ìƒ ë¯¸ì§€ì›, íƒœê·¸ë§Œ ì œê±° |
| `<g>text</g>` | `text` | ìƒ‰ìƒ ë¯¸ì§€ì›, íƒœê·¸ë§Œ ì œê±° |
| `<bl>text</bl>` | `text` | ìƒ‰ìƒ ë¯¸ì§€ì›, íƒœê·¸ë§Œ ì œê±° |
| `<u>text</u>` | `text` | ë°‘ì¤„ ë¯¸ì§€ì›, íƒœê·¸ë§Œ ì œê±° |
| `\n` | `\n` | ì¤„ë°”ê¿ˆ ìœ ì§€ |

## 2.4 ìŠ¬ë™ ë©”ì‹œì§€ í…œí”Œë¦¿ ë³€ìˆ˜

ì´ë©”ì¼ í…œí”Œë¦¿ê³¼ ë™ì¼í•œ ë³€ìˆ˜ ì²´ê³„ë¥¼ ê³µìœ í•©ë‹ˆë‹¤. Disclaimer ë³€ìˆ˜(`{updateDate}`, `{headsUp}`, `{iosReviewDate}`, `{paidProductDate}`)ëŠ” ê¸°ì¡´ `substituteDisclaimerVariables()` ìœ í‹¸ë¦¬í‹°ë¡œ ì¹˜í™˜í•©ë‹ˆë‹¤.

### í…œí”Œë¦¿ ë³€ìˆ˜ í‘œ

| ë³€ìˆ˜ëª… | íƒ€ì… | ì„¤ëª… | mrkdwn ì¶œë ¥ ì˜ˆì‹œ |
|--------|------|------|------------------|
| `{updateDate}` | string | ì—…ë°ì´íŠ¸ì¼ | `02/10(ì›”)` |
| `{updateDateShort}` | string | ì—…ë°ì´íŠ¸ì¼ (ì§§ì€ í˜•ì‹, MM-DD) | `02-10` |
| `{headsUp}` | string | í—¤ì¦ˆì—… ë‚ ì§œ | `01/28(í™”)` |
| `{iosReviewDate}` | string\|null | iOS ì‹¬ì‚¬ì¼ | `02/03(ì›”)` ë˜ëŠ” null |
| `{paidProductDate}` | string\|null | ìœ ë£Œí™” ìƒí’ˆ í˜‘ì˜ ì¼ì • | `01/20(ì›”)` ë˜ëŠ” null |
| `{table}` | string | ì¼ì • í…Œì´ë¸” (mrkdwn í˜•ì‹) | í…Œì´ë¸” í¬ë§·íŒ… ê²°ê³¼ |
| `{disclaimer}` | string\|null | Disclaimer (mrkdwn ë³€í™˜ í›„) | ë³€í™˜ëœ í…ìŠ¤íŠ¸ |
| `{projectName}` | string | í”„ë¡œì íŠ¸ ì´ë¦„ | `M4/GL` |
| `{showIosReviewDate}` | boolean | iOS ì‹¬ì‚¬ì¼ í‘œì‹œ ì—¬ë¶€ | ì¡°ê±´ë¶€ ë¸”ë¡ìš© |
| `{showPaidProductDate}` | boolean | ìœ ë£Œí™” ìƒí’ˆ í˜‘ì˜ í‘œì‹œ ì—¬ë¶€ | ì¡°ê±´ë¶€ ë¸”ë¡ìš© |

### ì¡°ê±´ë¶€ ë¸”ë¡

ì´ë©”ì¼ í…œí”Œë¦¿ê³¼ ë™ì¼í•œ ë¬¸ë²•ì„ ì‚¬ìš©í•©ë‹ˆë‹¤:

```
{{#if showIosReviewDate}}*iOS ì‹¬ì‚¬ì¼:* {iosReviewDate}{{/if}}
{{#if showPaidProductDate}}*ìœ ë£Œí™” ìƒí’ˆ í˜‘ì˜:* {paidProductDate}{{/if}}
{{#if disclaimer}}
---
_{disclaimer}_
{{/if}}
```

> **ì¤„ë°”ê¿ˆ ì²˜ë¦¬**: `renderTemplate()`ëŠ” ì¡°ê±´ì´ `false`ì¸ ë¸”ë¡ì„ **ê°œí–‰ í¬í•¨** ì™„ì „íˆ ì œê±°í•©ë‹ˆë‹¤. ì˜ˆ: `showIosReviewDate=false`ì´ë©´ í•´ë‹¹ `{{#if}}...{{/if}}` ë¸”ë¡ê³¼ ì „í›„ ë¹ˆ ì¤„ì´ ì œê±°ë˜ì–´ ì¶œë ¥ì— ë¹ˆ ì¤„ì´ ë‚¨ì§€ ì•ŠìŠµë‹ˆë‹¤.

### í•˜ì´ë¸Œë¦¬ë“œ íŒŒì„œ ì•„í‚¤í…ì²˜

ë³€ìˆ˜ ì¹˜í™˜ ë¡œì§ì€ ì´ë©”ì¼ê³¼ ìŠ¬ë™ì´ **ê³µìœ **í•˜ê³ , ì¶œë ¥ í¬ë§·í„°ë§Œ ë¶„ë¦¬í•©ë‹ˆë‹¤:

```
[ê³µìœ  ê³„ì¸µ]
  substituteDisclaimerVariables() â€” Disclaimer ë‚´ ë‚ ì§œ ë³€ìˆ˜ ì¹˜í™˜
  renderTemplate()               â€” ì¡°ê±´ë¶€ ë¸”ë¡ + ë³€ìˆ˜ ì¹˜í™˜ (templateParser.ts)
    â€» ë‚´ë¶€ decodeTemplateEntities()ëŠ” ìŠ¬ë™ textarea ì…ë ¥ì—ì„œ entityê°€ ì—†ìœ¼ë¯€ë¡œ ë¬´í•´í•˜ê²Œ í†µê³¼. ë³„ë„ íŒŒì„œ ë¶ˆí•„ìš”.

[ì´ë©”ì¼ ì „ìš©]
  formatTableHtml()              â€” HTML í…Œì´ë¸” ìƒì„±
  renderDisclaimerHtml()         â€” HTML ì„œì‹ íƒœê·¸ ë³€í™˜
  convertToInlineStyles()        â€” juice ì¸ë¼ì¸ CSS

[ìŠ¬ë™ ì „ìš©]
  formatTableMrkdwn()            â€” mrkdwn í…ìŠ¤íŠ¸ í…Œì´ë¸” ìƒì„±
  convertDisclaimerToMrkdwn()    â€” mrkdwn ì„œì‹ íƒœê·¸ ë³€í™˜
```

---

# 3. ìŠ¬ë™ ì—°ë™ ë°©ì‹

## 3.1 User OAuth Token ë°©ì‹

| í•­ëª© | ì„¤ëª… |
|------|------|
| **ë°©ì‹** | Slack App + User OAuth Token |
| **ì¥ì ** | ì‚¬ìš©ì ë³¸ì¸ ê³„ì •ìœ¼ë¡œ ë°œì‹ , ë©”ì‹œì§€ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥ (Slackì—ì„œ ì§ì ‘) |
| **User Token Scopes** | `chat:write`, `channels:read`, `groups:read` |
| **Token Rotation** | ë¯¸ì‚¬ìš© (ë¹„ë§Œë£Œ í† í°) |

> **ì¤‘ìš”**: OAuth URLì—ì„œ `user_scope` íŒŒë¼ë¯¸í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤ (`scope`ê°€ ì•„ë‹˜).
> `scope`ëŠ” Bot Tokenìš©ì´ê³ , `user_scope`ëŠ” User Tokenìš©ì…ë‹ˆë‹¤.

> **ë©”ì‹œì§€ ìˆ˜ì • ê¸°ëŠ¥**: Azraelì—ì„œ êµ¬í˜„í•˜ì§€ ì•ŠìŒ. Slackì—ì„œ ì§ì ‘ ìˆ˜ì •.

## 3.2 OAuth í”Œë¡œìš°

```
[ì„¤ì • > Slack íƒ­]
  â†“
[Slack ì—°ë™í•˜ê¸°] ë²„íŠ¼ í´ë¦­
  â†“
í”„ë¡ íŠ¸ì—”ë“œ:
  csrf = crypto.randomUUID()
  state = `${csrf}:${supabaseUid}`       // â† CSRF + Supabase UID ì¸ì½”ë”©
  localStorage.setItem('slack_oauth_state', csrf)  // CSRF ë¶€ë¶„ë§Œ ì €ì¥
  â†“
[OAuth íŒì—… ìœˆë„ìš°] (600x700)
  â”œâ”€ Slack ë¡œê·¸ì¸ (í•„ìš”ì‹œ)
  â”œâ”€ ê¶Œí•œ ìŠ¹ì¸
  â””â”€ ë¦¬ë‹¤ì´ë ‰íŠ¸ â†’ slack-oauth-callback Edge Function
  â†“
[Edge Function]:
  1. stateì—ì„œ supabaseUid ì¶”ì¶œ (`state.split(':')[1]`)
  2. code â†’ oauth.v2.access API â†’ access_token êµí™˜
  3. slack_user_tokens í…Œì´ë¸”ì— UPSERT (user_id = supabaseUid)
  4. íŒì—… ë‹«ê¸° HTML ì‘ë‹µ ë°˜í™˜ (postMessage í¬í•¨)
  â†“
[íŒì—… HTML í˜ì´ì§€]:
  1. data-* ì†ì„±ì—ì„œ csrf, userId ì½ê¸°
  2. localStorageì—ì„œ ì €ì¥ëœ csrfì™€ ë¹„êµ (CSRF ê²€ì¦)
  3. window.opener.postMessageë¡œ ë¶€ëª¨ ì°½ì— ì„±ê³µ ì „ë‹¬
  4. localStorage.removeItem('slack_oauth_state')
  5. window.close()
  â†“
[ë¶€ëª¨ ì°½]:
  message ì´ë²¤íŠ¸ ìˆ˜ì‹  â†’ alert('Slack ì—°ë™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.') + UI ê°±ì‹ 
```

### OAuth URL êµ¬ì¡°

```typescript
// SettingsSlackTab.tsx â€” OAuth ì‹œì‘
const SLACK_CLIENT_ID = import.meta.env.VITE_SLACK_CLIENT_ID;      // Vercel í™˜ê²½ë³€ìˆ˜
const REDIRECT_URI = import.meta.env.VITE_SLACK_REDIRECT_URI;      // Vercel í™˜ê²½ë³€ìˆ˜

const supabaseUid = session.user.id;  // Supabase auth user UUID
const csrf = crypto.randomUUID();
const state = `${csrf}:${supabaseUid}`;
localStorage.setItem('slack_oauth_state', csrf);  // CSRF ë¶€ë¶„ë§Œ ì €ì¥

const oauthUrl = `https://slack.com/oauth/v2/authorize?` +
  `client_id=${SLACK_CLIENT_ID}` +
  `&user_scope=chat:write,channels:read,groups:read` +  // âš ï¸ user_scope (Bot scope ì•„ë‹˜)
  `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
  `&state=${encodeURIComponent(state)}`;  // CSRF + supabaseUid
```

> **scope vs user_scope**:
> - `scope`: Bot Token ê¶Œí•œ â†’ ë´‡ ê³„ì •ìœ¼ë¡œ ë°œì‹ 
> - `user_scope`: User Token ê¶Œí•œ â†’ ì‚¬ìš©ì ë³¸ì¸ ê³„ì •ìœ¼ë¡œ ë°œì‹ 
> - Azraelì€ User Tokenì„ ì‚¬ìš©í•˜ë¯€ë¡œ ë°˜ë“œì‹œ `user_scope`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

### State íŒŒë¼ë¯¸í„° (CSRF ë°©ì§€) â€” í´ë¼ì´ì–¸íŠ¸ ê²€ì¦

```typescript
// === í”„ë¡ íŠ¸ì—”ë“œ: OAuth ì‹œì‘ ì‹œ ===
const csrf = crypto.randomUUID();
const state = `${csrf}:${supabaseUid}`;
localStorage.setItem('slack_oauth_state', csrf);  // CSRF ë¶€ë¶„ë§Œ ì €ì¥

// === Edge Function (slack-oauth-callback) ===
// stateì—ì„œ supabaseUid ì¶”ì¶œ â†’ user_idë¡œ ì‚¬ìš©
// CSRF ìì²´ëŠ” ê²€ì¦í•˜ì§€ ì•ŠìŒ (í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê²€ì¦)
const [csrf, supabaseUid] = (state || '').split(':');

// === ì½œë°± HTML í˜ì´ì§€ (íŒì—… ë‚´) ===
// data-* ì†ì„±ì—ì„œ ê°’ì„ ì½ì–´ XSS ë°©ì§€
const configEl = document.getElementById('oauth-config');
const urlCsrf = configEl.dataset.csrf;
const userId = configEl.dataset.userId;
const savedCsrf = localStorage.getItem('slack_oauth_state');
if (!savedCsrf || savedCsrf !== urlCsrf) {
  // CSRF ê²€ì¦ ì‹¤íŒ¨ â†’ ì—ëŸ¬ í‘œì‹œ, postMessage ë³´ë‚´ì§€ ì•ŠìŒ
  document.body.innerHTML = '<p>ë³´ì•ˆ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
} else {
  localStorage.removeItem('slack_oauth_state');
  window.opener.postMessage(
    { type: 'SLACK_OAUTH_SUCCESS', userId: userId },
    'https://azrael-002.vercel.app'
  );
  window.close();
}
```

### íŒì—… ì°¨ë‹¨ ê°ì§€ ë° ìˆ˜ë™ ë‹«ê¸° ì²˜ë¦¬

```typescript
const popup = window.open(oauthUrl, 'slack-oauth', 'width=600,height=700');
if (!popup || popup.closed) {
  alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
  return;
}

// ì‚¬ìš©ìê°€ íŒì—…ì„ ìˆ˜ë™ìœ¼ë¡œ ë‹«ì€ ê²½ìš° ê°ì§€ (setInterval + cleanup)
const popupCheckInterval = setInterval(() => {
  if (popup.closed) {
    clearInterval(popupCheckInterval);
    window.removeEventListener('message', handleOAuthMessage);  // ë¦¬ìŠ¤ë„ˆë„ í•¨ê»˜ ì •ë¦¬
    setIsOAuthPending(false);  // ë¡œë”© ìƒíƒœ í•´ì œ
  }
}, 500);
```

### postMessage ë³´ì•ˆ

```typescript
// ë¶€ëª¨ ì°½ì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ origin ê²€ì¦
// âš ï¸ ì½œë°± HTMLì€ Supabase Edge Function ë„ë©”ì¸ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ,
//    window.location.originì´ ì•„ë‹Œ SUPABASE_URLì„ ê²€ì¦í•´ì•¼ í•©ë‹ˆë‹¤.
const SUPABASE_ORIGIN = import.meta.env.VITE_SUPABASE_URL;  // https://vgoqkyqqkieogrtnmsva.supabase.co

const handleOAuthMessage = (event: MessageEvent) => {
  if (event.origin !== SUPABASE_ORIGIN) return;  // Supabase ë„ë©”ì¸ë§Œ í—ˆìš©
  if (event.data?.type === 'SLACK_OAUTH_SUCCESS') {
    clearInterval(popupCheckInterval);                          // interval ì •ë¦¬
    window.removeEventListener('message', handleOAuthMessage);  // ë¦¬ìŠ¤ë„ˆ ìì²´ ì •ë¦¬
    setIsOAuthPending(false);
    alert('Slack ì—°ë™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    refetchTokenStatus();  // React Query invalidate
  }
};
window.addEventListener('message', handleOAuthMessage);

// useEffect cleanup: ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ interval + ë¦¬ìŠ¤ë„ˆ ëª¨ë‘ ì •ë¦¬
// return () => { clearInterval(popupCheckInterval); window.removeEventListener('message', handleOAuthMessage); };
```

## 3.3 ì—°ë™ í•´ì œ ë° ì¬ì—°ë™

| ê¸°ëŠ¥ | ìœ„ì¹˜ | ë™ì‘ |
|------|------|------|
| **ì—°ë™ í•´ì œ** | ì„¤ì • > Slack íƒ­ | `slack_user_tokens` ë ˆì½”ë“œ ì‚­ì œ â†’ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ (`confirm('ì—°ë™ í•´ì œ ì‹œ ë©”ì‹œì§€ ë°œì‹ ì´ ë¶ˆê°€í•©ë‹ˆë‹¤. í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')`) |
| **ì¬ì—°ë™** | ì—°ë™ í•´ì œ í›„ ìˆ˜ë™ | [Slack ì—°ë™í•˜ê¸°] ë²„íŠ¼ ë‹¤ì‹œ í´ë¦­ |

---

# 4. UI í”Œë¡œìš°

## 4.1 ë²„íŠ¼ ìœ„ì¹˜

**ìƒë‹¨ ì•¡ì…˜ ë°”**ì— [ğŸ’¬ ìŠ¬ë™ ë°œì‹ ] ë²„íŠ¼ ë°°ì¹˜ ([ì´ë©”ì¼ ìƒì„±] ë²„íŠ¼ ì˜†)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ M4/GL â–¼                                                    [ì„¤ì •] [ë¡œê·¸ì•„ì›ƒ] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ì—…ë°ì´íŠ¸ì¼: 2026-02-10 (ì›”)  [ê³„ì‚°] [ì´ë©”ì¼ ìƒì„±] [ğŸ’¬ ìŠ¬ë™ ë°œì‹ ]            â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**MainScreen state**: `showSlackModal` boolean stateë¡œ ëª¨ë‹¬ í‘œì‹œ ì—¬ë¶€ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
```typescript
const [showSlackModal, setShowSlackModal] = useState(false);
```

### ë²„íŠ¼ í™œì„±í™” ì¡°ê±´

| ìƒíƒœ | [ìŠ¬ë™ ë°œì‹ ] |
|------|-------------|
| ê³„ì‚° ê²°ê³¼ ì—†ìŒ | ë¹„í™œì„±í™” (íˆ´íŒ: "ë¨¼ì € ê³„ì‚°ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”") |
| ê³„ì‚° ê²°ê³¼ ìˆìŒ + Slack ë¯¸ì—°ë™ | ë¹„í™œì„±í™” (íˆ´íŒ: "ì„¤ì •ì—ì„œ Slack ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤") |
| ê³„ì‚° ê²°ê³¼ ìˆìŒ + Slack ì—°ë™ë¨ | í™œì„±í™” |

### MainScreen ìˆ˜ì •ì‚¬í•­

`useSlackTokenStatus(userId)` í˜¸ì¶œì„ ìœ„í•´ MainScreenì— `currentUserId` stateë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤:

```typescript
// MainScreen.tsx â€” ê¸°ì¡´ supabase.auth.getUser() í˜¸ì¶œ ìœ„ì¹˜ì—ì„œ user.idë„ í•¨ê»˜ ì €ì¥
const [currentUserId, setCurrentUserId] = useState<string>('');

useEffect(() => {
  supabase.auth.getUser().then(({ data: { user } }) => {
    if (user?.id) setCurrentUserId(user.id);
    // ... ê¸°ì¡´ ì´ë©”ì¼ ì„¤ì • ì½”ë“œ ...
  });
}, []);
```

### Slack í† í° ìƒíƒœ ì¡°íšŒ

í”„ë¡ íŠ¸ì—”ë“œì—ì„œ í† í° ì¡´ì¬ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” APIì™€ í›… (ë³¸ì¸ì˜ userIdë§Œ ì¡°íšŒ ê°€ëŠ¥, RLS ì œì•½):

```typescript
// src/lib/api/slack.ts
export async function checkSlackTokenStatus(userId: string): Promise<boolean> {
  const { data, error } = await supabase
    .from('slack_user_tokens')
    .select('id')
    .eq('user_id', userId)
    .maybeSingle();
  return !error && data !== null;
}

// src/hooks/useSlackTokenStatus.ts
export function useSlackTokenStatus(userId: string | undefined) {
  return useQuery({
    queryKey: ['slack-token-status', userId],
    queryFn: () => checkSlackTokenStatus(userId!),
    enabled: !!userId,  // userIdê°€ undefined/ë¹ˆë¬¸ìì—´ì´ë©´ ì¿¼ë¦¬ ë¹„í™œì„±í™” â†’ getUser() ì‹¤íŒ¨/ë¡œë”© ì¤‘ì—ë„ ì•ˆì „
  });
}
```

## 4.2 ë°œì‹  í”Œë¡œìš°

```
[ìŠ¬ë™ ë°œì‹ ] ë²„íŠ¼ í´ë¦­
  â†“
[ìŠ¬ë™ ë°œì‹  ëª¨ë‹¬] (lazy load)
  â”œâ”€ í…Œì´ë¸” ì„ íƒ: â—‹ T1(ë‚´ë¶€) â— T2(Ext.) â—‹ T3(Int.)  â† ê¸°ë³¸ ì„ íƒ: T2 (Ext.)
  â”œâ”€ í…œí”Œë¦¿ ì„ íƒ: [ê¸°ë³¸ í…œí”Œë¦¿ â–¼]
  â”œâ”€ ì±„ë„ ì„ íƒ: #l10n-mir4 â–¼ (í”„ë¡œì íŠ¸ ê¸°ë³¸ ì±„ë„ ìë™ ì„ íƒ)
  â”œâ”€ ìŠ¤ë ˆë“œ ì˜µì…˜: â–¡ ê¸°ì¡´ ë©”ì‹œì§€ì— ë¦¬í”Œë¼ì´ (thread_ts ì…ë ¥)
  â”œâ”€ ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸° (ê°„ì´ mrkdwn ë Œë”ë§)
  â””â”€ í•˜ë‹¨ ë²„íŠ¼: [ì·¨ì†Œ] [ìŠ¬ë™ì— ë°œì‹ ]
  â†“
[ìŠ¬ë™ì— ë°œì‹ ] í´ë¦­ (isSending state â†’ ë²„íŠ¼ disabled + í…ìŠ¤íŠ¸ "ë°œì‹  ì¤‘...")
  â†“
slack-send Edge Function í˜¸ì¶œ
  â†“
ì„±ê³µ: alert("#{ì±„ë„}ì— ë°œì‹ ë˜ì—ˆìŠµë‹ˆë‹¤") + ëª¨ë‹¬ ë‹«í˜
ì‹¤íŒ¨: alert(ì—ëŸ¬ ë©”ì‹œì§€) + ëª¨ë‹¬ ìœ ì§€ (ì¬ì‹œë„ ê°€ëŠ¥)
  â†’ ëª¨ë“  ì…ë ¥ ìƒíƒœ(í…Œì´ë¸”/í…œí”Œë¦¿/ì±„ë„/ìŠ¤ë ˆë“œ) ìœ ì§€
  â†’ [ìŠ¬ë™ì— ë°œì‹ ] ë²„íŠ¼ ì¬í™œì„±í™” (isSending = false)
  â†’ ì‚¬ìš©ìê°€ ì„ íƒ ìˆ˜ì • í›„ ì¬ì‹œë„ ê°€ëŠ¥
```

## 4.3 ëª¨ë‹¬ UI ìƒì„¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ìŠ¬ë™ ë°œì‹                                                   [âœ•] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ í…Œì´ë¸” ì„ íƒ                              ê¸°ë³¸ ì„ íƒ: T2 (Ext.)    â”‚
â”‚ â—‹ í…Œì´ë¸” 1 (ë‚´ë¶€ ì¼ì •í‘œ)                                        â”‚
â”‚ â— í…Œì´ë¸” 2 (Ext. ì™¸ë¶€ìš©)  â† ê¸°ë³¸ ì„ íƒ                           â”‚
â”‚ â—‹ í…Œì´ë¸” 3 (Int. ë‚´ë¶€ìš©)                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ í…œí”Œë¦¿                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ê¸°ë³¸ í…œí”Œë¦¿                                             â–¼  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ì±„ë„ ì„ íƒ                                                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ #l10n-mir4                                              â–¼  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ ì±„ë„ ë¯¸ì„¤ì • ì‹œ: placeholder "ì„¤ì •ì—ì„œ ê¸°ë³¸ ì±„ë„ì„ ì„ íƒí•´ì£¼ì„¸ìš”"   â”‚
â”‚   â†’ [ìŠ¬ë™ì— ë°œì‹ ] ë²„íŠ¼ disabled (ì±„ë„ ì„ íƒ í•„ìˆ˜)                 â”‚
â”‚ ì±„ë„ ëª©ë¡ ë¡œë”© ì¤‘: "ì±„ë„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."                        â”‚
â”‚ ì±„ë„ ëª©ë¡ ì—ëŸ¬: "ì±„ë„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. [ë‹¤ì‹œ ì‹œë„]"     â”‚
â”‚   â†’ [ë‹¤ì‹œ ì‹œë„] í´ë¦­ ì‹œ refetch() í˜¸ì¶œ                             â”‚
â”‚   â†’ ì¬ì‹œë„ ì¤‘: ë²„íŠ¼ disabled + í…ìŠ¤íŠ¸ "ë‹¤ì‹œ ì‹œë„ ì¤‘..."              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–¡ ê¸°ì¡´ ë©”ì‹œì§€ì— ë¦¬í”Œë¼ì´                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ ë©”ì‹œì§€ ë§í¬ ë˜ëŠ” thread_ts ì…ë ¥                           â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸°         (min-height: 100px, max-height: 300px)   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ *[02-10 ì—…ë°ì´íŠ¸ ì¼ì •]*                                     â”‚ â”‚  â†‘
â”‚ â”‚                                                             â”‚ â”‚  â”‚
â”‚ â”‚ *í—¤ì¦ˆì—…:* 01/28(í™”)                                        â”‚ â”‚  max-height:
â”‚ â”‚ *iOS ì‹¬ì‚¬ì¼:* 02/03(ì›”)                                    â”‚ â”‚  300px,
â”‚ â”‚ ---                                                         â”‚ â”‚  overflow-y:
â”‚ â”‚ ...                                                         â”‚ â”‚  auto
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                    [ì·¨ì†Œ]  [ìŠ¬ë™ì— ë°œì‹ ]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ê°„ì´ mrkdwn ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§

ëª¨ë‹¬ì˜ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ì€ mrkdwnì„ **ê°„ì´ HTMLë¡œ ë³€í™˜**í•˜ì—¬ í‘œì‹œí•©ë‹ˆë‹¤. ë³€í™˜ í•¨ìˆ˜ `renderMrkdwnPreview(mrkdwn: string): string`ì€ `src/lib/slack/formatter.ts`ì— ë°°ì¹˜í•©ë‹ˆë‹¤.

**ë³€í™˜ ìˆœì„œ** (XSS ë°©ì§€):
1. HTML entity escape (`<`, `>`, `&`, `"`, `'`)
2. mrkdwn â†’ HTML ë³€í™˜ (ì•„ë˜ í‘œ)
3. URL ë§í¬ ë³€í™˜ ì‹œ `http://` ë˜ëŠ” `https://` í”„ë¡œí† ì½œë§Œ í—ˆìš© (`javascript:` ë“± ì°¨ë‹¨)

| mrkdwn | HTML ë³€í™˜ | ë¹„ê³  |
|--------|-----------|------|
| `*bold*` | `<strong>bold</strong>` | Bold |
| `_italic_` | `<em>italic</em>` | Italic |
| `~strike~` | `<del>strike</del>` | Strikethrough |
| `---` | `<hr>` | ìˆ˜í‰ì„  |
| `<url\|text>` | `<a href="url">text</a>` | ë§í¬ (http/httpsë§Œ) |
| `\n` | `<br>` | ì¤„ë°”ê¿ˆ |

> **ì°¸ê³ **: ì™„ë²½í•œ Slack ë Œë”ë§ì´ ì•„ë‹Œ ê·¼ì‚¬ì¹˜ì…ë‹ˆë‹¤. ì§€ì›ë˜ì§€ ì•ŠëŠ” mrkdwn êµ¬ë¬¸(ì½”ë“œ ë¸”ë¡ ë“±)ì€ ì›ë¬¸ ê·¸ëŒ€ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
>
> **ë³´ì•ˆ ì°¸ê³ **: ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ì€ `dangerouslySetInnerHTML`ë¡œ ë Œë”ë§í•©ë‹ˆë‹¤. `renderMrkdwnPreview` ë³€í™˜ í•¨ìˆ˜ì—ì„œ HTML entity escapeë¥¼ **ë¨¼ì €** ìˆ˜í–‰í•œ ë’¤ mrkdwnâ†’HTML ë³€í™˜ì„ ì ìš©í•˜ë¯€ë¡œ, ì‚¬ìš©ì ì…ë ¥ì— ì˜í•œ XSS ìœ„í—˜ì´ ì—†ìŠµë‹ˆë‹¤.

### ìŠ¤ë ˆë“œ ë¦¬í”Œë¼ì´

ìŠ¤ë ˆë“œ ë¦¬í”Œë¼ì´ë¥¼ ìœ„í•´ ì‚¬ìš©ìê°€ `thread_ts`ë¥¼ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- **ì…ë ¥ ë°©ì‹**: ìŠ¬ë™ ë©”ì‹œì§€ ë§í¬ URL ë˜ëŠ” ì§ì ‘ `thread_ts` ê°’ ì…ë ¥
- **URL íŒŒì‹±**: `https://team.slack.com/archives/C123/p1234567890123456` â†’ `thread_ts: "1234567890.123456"` ìë™ ë³€í™˜. íŒŒì‹± í•¨ìˆ˜ `parseThreadTs(input: string): string | null`ì€ `src/lib/slack/formatter.ts`ì— ë°°ì¹˜.
- **ìœ íš¨ì„± ê²€ì¦**: í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë³„ë„ ê²€ì¦í•˜ì§€ ì•ŠìŒ. ì˜ëª»ëœ `thread_ts`ëŠ” Slack APIê°€ ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ë©°, Â§7.1 ì—ëŸ¬ ì²˜ë¦¬ íë¦„ì„ ë”°ë¦„. (ë‚´ë¶€ 6ëª… ì‚¬ìš©ì´ë¯€ë¡œ ì‚¬ì „ ê²€ì¦ ë¶ˆí•„ìš”)
- **ì²´í¬ë°•ìŠ¤ í•´ì œ ì‹œ**: `thread_ts` ì…ë ¥ í•„ë“œ ìˆ¨ê¹€, ìƒˆ ë©”ì‹œì§€ë¡œ ë°œì‹ 
- **ì²´í¬ë°•ìŠ¤ ì²´í¬ + ë¹ˆ ì…ë ¥**: [ìŠ¬ë™ì— ë°œì‹ ] ë²„íŠ¼ disabled (thread_ts í•„ìˆ˜)
- **ë°œì‹  í›„**: ì„±ê³µ ì‘ë‹µì˜ `message_ts`ëŠ” ë³„ë„ ì €ì¥í•˜ì§€ ì•ŠìŒ

---

# 5. ì„¤ì • > Slack íƒ­

ê¸°ì¡´ SettingsScreenì— 6ë²ˆì§¸ íƒ­ìœ¼ë¡œ **Slack** íƒ­ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

## 5.1 íƒ­ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì„¤ì •                                                       [âœ•] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ í”„ë¡œì íŠ¸â”‚                                                       â”‚
â”‚ ì—…ë¬´ë‹¨ê³„â”‚  [Slack íƒ­ ë‚´ìš©]                                       â”‚
â”‚ ê³µíœ´ì¼  â”‚                                                       â”‚
â”‚ JIRA   â”‚                                                       â”‚
â”‚ ì´ë©”ì¼  â”‚                                                       â”‚
â”‚ Slack  â”‚ â† ìƒˆë¡œ ì¶”ê°€                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SettingsScreen ìˆ˜ì •ì‚¬í•­

```typescript
// SettingsScreen.tsx â€” í•„ìš”í•œ ë³€ê²½ì‚¬í•­:
// 1. SettingsTab ìœ ë‹ˆì˜¨ íƒ€ì…ì— 'slack' ì¶”ê°€
type SettingsTab = 'projects' | 'stages' | 'holidays' | 'jira' | 'emailTemplates' | 'slack';

// 2. lazy import ì¶”ê°€ (ê¸°ì¡´ named export + .then() ë˜í•‘ íŒ¨í„´ê³¼ ë™ì¼)
const SettingsSlackTab = lazy(() => import('./settings/SettingsSlackTab').then(m => ({ default: m.SettingsSlackTab })));

// 3. currentUserId + currentUserEmailì€ MainScreenì—ì„œ propsë¡œ ì „ë‹¬ë°›ìŒ (ì¤‘ë³µ ì¡°íšŒ ë°©ì§€)
//    SettingsScreenProps ì¸í„°í˜ì´ìŠ¤:
//    interface SettingsScreenProps {
//      ... ê¸°ì¡´ props ...
//      currentUserId: string;      // Supabase auth user UUID
//      currentUserEmail: string;   // ì‚¬ìš©ì ì´ë©”ì¼ (OAuth, í‘œì‹œìš©)
//    }
//    MainScreenì—ì„œ 1íšŒ ì¡°íšŒ â†’ SettingsScreen, SlackSendModalì— ë™ì¼ ê°’ ì „ë‹¬
//    SettingsScreen ë‚´ë¶€ supabase.auth.getUser() í˜¸ì¶œ ì œê±° (propsë¡œ ëŒ€ì²´)

// 4. ì‚¬ì´ë“œë°” navì— Slack ë²„íŠ¼ ì¶”ê°€ (ARIA: aria-controls="settings-panel-slack")
// 5. activeTab === 'slack' ì‹œ SettingsSlackTab ë Œë”ë§ (id="settings-panel-slack" role="tabpanel")
```

### SettingsSlackTab Props

```typescript
interface SettingsSlackTabProps {
  currentUserEmail: string;       // í˜„ì¬ ì‚¬ìš©ì ì´ë©”ì¼ (OAuthìš©)
  currentUserId: string;          // í˜„ì¬ ì‚¬ìš©ì Supabase UID
  selectedProjectId: string;      // ì„ íƒëœ í”„ë¡œì íŠ¸ ID (ì±„ë„ ë§¤í•‘ìš©)
  projects: Project[];            // ì „ì²´ í”„ë¡œì íŠ¸ ëª©ë¡ (ì±„ë„ ë§¤í•‘ í‘œì‹œìš©)
}
```

## 5.2 Slack íƒ­ ë‚´ìš©

### 5.2.1 ì—°ë™ ìƒíƒœ ì„¹ì…˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Slack ì—°ë™                                                       â”‚
â”‚                                                                   â”‚
â”‚ ë¯¸ì—°ë™ ìƒíƒœ:                                                      â”‚
â”‚   [Slack ì—°ë™í•˜ê¸°] ë²„íŠ¼                                            â”‚
â”‚                                                                   â”‚
â”‚ ì—°ë™ ì™„ë£Œ ìƒíƒœ:                                                    â”‚
â”‚   âœ… ì—°ë™ë¨ (workspace: wemade)  [ì—°ë™ í•´ì œ]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ìºì‹œ ë¬´íš¨í™”**: ì—°ë™ ì„±ê³µ(postMessage ìˆ˜ì‹  ì‹œ) ë° ì—°ë™ í•´ì œ ì™„ë£Œ ì‹œ, `queryClient.invalidateQueries({ queryKey: ['slack-token-status'] })`ë¥¼ í˜¸ì¶œí•˜ì—¬ MainScreenì˜ [ìŠ¬ë™ ë°œì‹ ] ë²„íŠ¼ í™œì„±í™” ìƒíƒœë¥¼ ì¦‰ì‹œ ë°˜ì˜í•©ë‹ˆë‹¤.

### 5.2.2 ì±„ë„ ë§¤í•‘ ì„¹ì…˜

Slack ì—°ë™ ì™„ë£Œ ì‹œì—ë§Œ í‘œì‹œë©ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ í”„ë¡œì íŠ¸ë³„ ê¸°ë³¸ ì±„ë„                                               â”‚
â”‚                                                                   â”‚
â”‚ M4/GL      [#l10n-mir4        â–¼]                                 â”‚
â”‚ NC/GL (1ì£¼) [#l10n-nightcrows  â–¼]                                â”‚
â”‚ NC/GL (2ì£¼) [#l10n-nightcrows  â–¼]                                â”‚
â”‚ ...                                                               â”‚
â”‚                                                                   â”‚
â”‚ â“˜ ë°œì‹  ì‹œ ê¸°ë³¸ ì„ íƒë˜ëŠ” ì±„ë„ì…ë‹ˆë‹¤. ë°œì‹  ëª¨ë‹¬ì—ì„œ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤.    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- ì±„ë„ ë“œë¡­ë‹¤ìš´ì€ `slack-channels` Edge Functionìœ¼ë¡œ ì‹¤ì‹œê°„ ì¡°íšŒ
- ì±„ë„ ë“œë¡­ë‹¤ìš´ ë¡œë”© ì¤‘: "ì±„ë„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..." í‘œì‹œ
- ì±„ë„ ë“œë¡­ë‹¤ìš´ ì—ëŸ¬: "ì±„ë„ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨" + [ë‹¤ì‹œ ì‹œë„] ë²„íŠ¼
- **ì €ì¥ ë°©ì‹: ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì¦‰ì‹œ ìë™ ì €ì¥** (ë³„ë„ ì €ì¥ ë²„íŠ¼ ì—†ìŒ, `onChange` ì´ë²¤íŠ¸ì—ì„œ `saveChannelMapping()` í˜¸ì¶œ)
- ì„ íƒí•œ ë§¤í•‘ì€ `projects` í…Œì´ë¸”ì˜ `slack_channel_id`, `slack_channel_name` ì»¬ëŸ¼ì— ì €ì¥. ì €ì¥ ì„±ê³µ ì‹œ `queryClient.invalidateQueries({ queryKey: ['projects'] })`ë¥¼ í˜¸ì¶œí•˜ì—¬ í”„ë¡œì íŠ¸ ìºì‹œë¥¼ ê°±ì‹ 
- **ì €ì¥ ì‹¤íŒ¨ ì‹œ**: `alert('ì±„ë„ ë§¤í•‘ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.')` + ë“œë¡­ë‹¤ìš´ ê°’ì„ ì´ì „ ê°’ìœ¼ë¡œ ë³µì› (optimistic update + onError ë¡¤ë°±):
  ```typescript
  // useMutation optimistic update íŒ¨í„´
  const mutation = useMutation({
    mutationFn: (channel: { id: string; name: string } | null) =>
      saveChannelMapping(projectId, channel),
    onMutate: async (newChannel) => {
      await queryClient.cancelQueries({ queryKey: ['projects'] });
      const prev = queryClient.getQueryData(['projects']);
      // optimistic: ì¦‰ì‹œ UI ë°˜ì˜
      queryClient.setQueryData(['projects'], (old: Project[]) =>
        old.map(p => p.id === projectId
          ? { ...p, slackChannelId: newChannel?.id ?? null, slackChannelName: newChannel?.name ?? null }
          : p
        )
      );
      return { prev };
    },
    onError: (_err, _vars, context) => {
      queryClient.setQueryData(['projects'], context?.prev);  // ë¡¤ë°±
      alert('ì±„ë„ ë§¤í•‘ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    },
    onSettled: () => queryClient.invalidateQueries({ queryKey: ['projects'] }),
  });
  ```
- í”„ë¡œì íŠ¸ë‹¹ 1ê°œì˜ ê¸°ë³¸ ì±„ë„ë§Œ ì„¤ì • ê°€ëŠ¥
- "ì—†ìŒ" ì˜µì…˜ í¬í•¨ (ê¸°ë³¸ ì±„ë„ ë¯¸ì„¤ì • â†’ `slack_channel_id = NULL`)
- ì±„ë„ ëª©ë¡ì€ pagination ì—†ì´ ê³µê°œ ìµœëŒ€ 200ê°œ + ë¹„ê³µê°œ ìµœëŒ€ 200ê°œ (í•©ê³„ ìµœëŒ€ 400ê°œ) í‘œì‹œ. ì´ë¥¼ ì´ˆê³¼í•˜ëŠ” ì±„ë„ì€ í‘œì‹œë˜ì§€ ì•ŠìŒ. (ì˜ë„ì  ê²°ì •: ë‚´ë¶€ ë„êµ¬ì´ë©° í˜„ì¬ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê·œëª¨ìƒ ì¶©ë¶„. ë¹„ê³µê°œ ì±„ë„ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ê³µê°œ ì±„ë„ë§Œ í‘œì‹œí•˜ëŠ” graceful degradation ì ìš©)
- **ë¹„ê³µê°œ ì±„ë„ ì¡°íšŒ ì‹¤íŒ¨ warning**: `slack-channels` Edge Function ì‘ë‹µì˜ `warning === 'PRIVATE_CHANNELS_UNAVAILABLE'` ì‹œ, ì±„ë„ ë“œë¡­ë‹¤ìš´ í•˜ë‹¨ì— ê²½ê³  í…ìŠ¤íŠ¸ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤: `âš ï¸ ë¹„ê³µê°œ ì±„ë„ ì¼ë¶€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`. ìŠ¤íƒ€ì¼: `color: var(--color-warning)`, `font-size: 0.85rem`. ë™ì¼í•œ warningì„ SlackSendModalì˜ ì±„ë„ ë“œë¡­ë‹¤ìš´ì—ë„ í‘œì‹œí•©ë‹ˆë‹¤.

### 5.2.3 ë©”ì‹œì§€ í…œí”Œë¦¿ ì„¹ì…˜

Slack ì—°ë™ ì™„ë£Œ ì‹œì—ë§Œ í‘œì‹œë©ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ë©”ì‹œì§€ í…œí”Œë¦¿                                                     â”‚
â”‚                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ê¸°ë³¸ í…œí”Œë¦¿ (built-in)                              [í¸ì§‘]  â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ QAíŒ€ìš© ê°„ëµ ë²„ì „                          [í¸ì§‘] [ì‚­ì œ]      â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ í˜‘ë ¥ì‚¬ìš© ìƒì„¸ ë²„ì „                         [í¸ì§‘] [ì‚­ì œ]     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚ [+ ìƒˆ í…œí”Œë¦¿ ì¶”ê°€]                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**[+ ìƒˆ í…œí”Œë¦¿ ì¶”ê°€] í´ë¦­ ì‹œ**: í¸ì§‘ ëª¨ë‹¬ê³¼ ë™ì¼í•œ ëª¨ë‹¬ì„ ì˜¤í”ˆí•©ë‹ˆë‹¤. ì´ˆê¸°ê°’: name="" (ë¹ˆì¹¸), bodyTemplate="" (ë¹ˆì¹¸, í•˜ë‹¨ ë³€ìˆ˜ ê°€ì´ë“œ ì°¸ê³ ). ì €ì¥ ì‹œ `isBuiltIn=false`, `createdBy=í˜„ì¬ ì‚¬ìš©ì ì´ë©”ì¼`ë¡œ ìë™ ì„¤ì •ë©ë‹ˆë‹¤.

> **ê¸°ë³¸ ì œê³µ í…œí”Œë¦¿ í¸ì§‘ ì •ì±…**: ê¸°ë³¸ í…œí”Œë¦¿(built-in)ì€ `bodyTemplate`ë§Œ ì§ì ‘ í¸ì§‘ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì´ë¦„ í•„ë“œëŠ” `readonly`ë¡œ í‘œì‹œí•˜ì—¬ ë³€ê²½ ë¶ˆê°€. `is_built_in` ìƒíƒœëŠ” ìœ ì§€ë˜ë©°, ì‚­ì œëŠ” ë¶ˆê°€í•©ë‹ˆë‹¤. ì´ë©”ì¼ í…œí”Œë¦¿ê³¼ ë™ì¼í•œ ì •ì±…ì…ë‹ˆë‹¤.

### 5.2.4 í…œí”Œë¦¿ í¸ì§‘ UI

ì´ë©”ì¼ í…œí”Œë¦¿ê³¼ ë‹¬ë¦¬, ìŠ¬ë™ í…œí”Œë¦¿ì€ **plain textarea**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤ (TipTap ë¯¸ì‚¬ìš©, mrkdwnì€ ë§ˆí¬ë‹¤ìš´ì´ë¯€ë¡œ WYSIWYG ë¶ˆí•„ìš”).

**í¸ì§‘ ë°©ì‹**: **ëª¨ë‹¬** ì‚¬ìš© (ê¸°ì¡´ `EmailTemplateEditModal` íŒ¨í„´ê³¼ ë™ì¼). í…œí”Œë¦¿ ëª©ë¡ì˜ [í¸ì§‘] ë²„íŠ¼ í´ë¦­ â†’ ëª¨ë‹¬ ì˜¤í”ˆ â†’ í¸ì§‘ â†’ [ì €ì¥] í´ë¦­ â†’ ëª¨ë‹¬ ë‹«í˜:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ í…œí”Œë¦¿ í¸ì§‘: QAíŒ€ìš© ê°„ëµ ë²„ì „                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ í…œí”Œë¦¿ ì´ë¦„                                maxLength={50}        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ QAíŒ€ìš© ê°„ëµ ë²„ì „                                            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ë©”ì‹œì§€ ë³¸ë¬¸ (mrkdwn)                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ *[{updateDateShort} ì—…ë°ì´íŠ¸ ì¼ì •]*                          â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚ *í—¤ì¦ˆì—…:* {headsUp}                                         â”‚ â”‚
â”‚ â”‚ {{#if showIosReviewDate}}*iOS ì‹¬ì‚¬ì¼:* {iosReviewDate}{{/if}} â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚ ---                                                         â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚ {table}                                                     â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚ {{#if disclaimer}}                                          â”‚ â”‚
â”‚ â”‚ ---                                                         â”‚ â”‚
â”‚ â”‚ _{disclaimer}_                                              â”‚ â”‚
â”‚ â”‚ {{/if}}                                                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚ ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜: {updateDate} {updateDateShort} {headsUp}         â”‚
â”‚   {iosReviewDate} {paidProductDate} {table} {disclaimer}          â”‚
â”‚   {projectName}                                                    â”‚
â”‚ ì¡°ê±´ë¶€: {{#if showIosReviewDate}}...{{/if}}                       â”‚
â”‚   {{#if showPaidProductDate}}...{{/if}} {{#if disclaimer}}...{{/if}} â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              [ì·¨ì†Œ] [ì €ì¥]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ì´ë©”ì¼ í…œí”Œë¦¿ê³¼ì˜ ì°¨ì´ì **:
- ì—ë””í„°: TipTap (HTML) â†’ plain textarea (mrkdwn)
- `subject_template` í•„ë“œ ì—†ìŒ (ìŠ¬ë™ ë©”ì‹œì§€ì— ì œëª© ê°œë… ì—†ìŒ)
- HTML entity ë””ì½”ë”© ë¶ˆí•„ìš” (textareaëŠ” entity ë³€í™˜í•˜ì§€ ì•ŠìŒ)
- ì¶œë ¥ í˜•ì‹: HTML â†’ mrkdwn

---

# 6. ê¸°ìˆ  êµ¬í˜„

## 6.1 ë°ì´í„° êµ¬ì¡°

### TypeScript ì¸í„°í˜ì´ìŠ¤

ì•„ë˜ íƒ€ì…ë“¤ì€ ëª¨ë‘ `src/types/index.ts`ì— ì¶”ê°€í•©ë‹ˆë‹¤ (ê¸°ì¡´ EmailTemplateê³¼ ë™ì¼ ìœ„ì¹˜).

```typescript
// === ìŠ¬ë™ ë°œì‹  ëª¨ë‹¬ Props ===

// ì°¸ê³ : EmailGeneratorModalì€ userId ë¶ˆí•„ìš” (Supabase auth ì§ì ‘ í˜¸ì¶œ ì—†ìŒ).
// SlackSendModalì€ slack-send Edge Function í˜¸ì¶œ ì‹œ userId í•„ìˆ˜.
interface SlackSendModalProps {
  isOpen: boolean;
  onClose: () => void;
  project: Project;              // í˜„ì¬ ì„ íƒëœ í”„ë¡œì íŠ¸
  calculationResult: CalculationResult;  // ê³„ì‚° ê²°ê³¼ (í…Œì´ë¸” ë°ì´í„°)
  currentUserId: string;         // Slack API í˜¸ì¶œìš© Supabase UID
}

// === ìŠ¬ë™ ë°œì‹  ìš”ì²­/ì‘ë‹µ ===

interface SlackSendRequest {
  channelId: string;           // Slack ì±„ë„ ID (ì˜ˆ: C0123456789)
  message: string;             // mrkdwn í˜•ì‹ ë©”ì‹œì§€ (ë Œë”ë§ ì™„ë£Œëœ ìµœì¢… í…ìŠ¤íŠ¸)
  userId: string;              // ë°œì‹ ì user_id (Supabase auth.uid())
  threadTs?: string;           // ìŠ¤ë ˆë“œ ë¦¬í”Œë¼ì´ ì‹œ ë¶€ëª¨ ë©”ì‹œì§€ timestamp
}

interface SlackSendResponse {
  success: boolean;
  messageTs?: string;          // ë°œì‹ ëœ ë©”ì‹œì§€ timestamp (ì„±ê³µ ì‹œ)
  error?: string;              // ì‚¬ìš©ììš© ì—ëŸ¬ ë©”ì‹œì§€
  errorCode?: string;          // í”„ë¡œê·¸ë˜ë°ìš© ì—ëŸ¬ ì½”ë“œ
  retryAfter?: number;         // Rate limit ì‹œ ì¬ì‹œë„ ëŒ€ê¸° ì‹œê°„ (ì´ˆ)
}

// === ìŠ¬ë™ ì±„ë„ (ëŸ°íƒ€ì„ ì „ìš©, DB ì €ì¥ ì—†ìŒ) ===
// Slack API conversations.list ì‘ë‹µì—ì„œ ì¶”ì¶œí•˜ëŠ” ë°ì´í„° êµ¬ì¡°.
// DBì—ëŠ” projects.slack_channel_id/slack_channel_nameì— ì¼ë¶€ í•„ë“œë§Œ ì €ì¥.

interface SlackChannel {
  id: string;                  // Slack ì±„ë„ ID
  name: string;                // ì±„ë„ ì´ë¦„ (ì˜ˆ: "l10n-mir4")
  isPrivate: boolean;          // ë¹„ê³µê°œ ì±„ë„ ì—¬ë¶€
}

// === ìŠ¬ë™ ë©”ì‹œì§€ í…œí”Œë¦¿ ===

interface SlackMessageTemplate {
  id: string;                  // UUID
  projectId: string;           // ì†Œì† í”„ë¡œì íŠ¸ ID
  name: string;                // í…œí”Œë¦¿ ì´ë¦„ (í”„ë¡œì íŠ¸ ë‚´ UNIQUE, ìµœëŒ€ 50ì)
  bodyTemplate: string;        // ë³¸ë¬¸ í…œí”Œë¦¿ (mrkdwn, ë³€ìˆ˜/ì¡°ê±´ë¶€ ë¸”ë¡ ì§€ì›)
  isBuiltIn: boolean;          // ê¸°ë³¸ ì œê³µ í…œí”Œë¦¿ ì—¬ë¶€ (true=ì‚­ì œ ë¶ˆê°€)
  createdAt: string;           // ISO 8601
  createdBy: string | null;    // ìƒì„±ì ì´ë©”ì¼ ('SYSTEM' ë˜ëŠ” ì‚¬ìš©ì ì´ë©”ì¼)
  updatedAt: string;           // ISO 8601
}
```

### Supabase íƒ€ì… ì •ì˜ (src/types/supabase.ts)

ê¸°ì¡´ `Database` ì¸í„°í˜ì´ìŠ¤ì˜ `Tables`ì— ì•„ë˜ 2ê°œ í…Œì´ë¸” íƒ€ì…ì„ ì¶”ê°€í•©ë‹ˆë‹¤:

```typescript
// src/types/supabase.ts â€” Database.public.Tablesì— ì¶”ê°€

slack_user_tokens: {
  Row: {
    id: string;
    user_id: string;
    access_token: string;
    slack_user_id: string;
    team_id: string;
    team_name: string | null;
    created_at: string;
    updated_at: string;
  };
  Insert: {
    id?: string;
    user_id: string;
    access_token: string;
    slack_user_id: string;
    team_id: string;
    team_name?: string | null;
    created_at?: string;
    updated_at?: string;
  };
  Update: {
    id?: string;
    user_id?: string;
    access_token?: string;
    slack_user_id?: string;
    team_id?: string;
    team_name?: string | null;
    created_at?: string;
    updated_at?: string;
  };
  Relationships: [];
};
slack_message_templates: {
  Row: {
    id: string;
    project_id: string;
    name: string;
    body_template: string;
    is_built_in: boolean;
    created_at: string;
    created_by: string | null;
    updated_at: string;
  };
  Insert: {
    id?: string;
    project_id: string;
    name: string;
    body_template: string;
    is_built_in?: boolean;
    created_by?: string | null;
  };
  Update: {
    name?: string;
    body_template?: string;
  };
  Relationships: [
    {
      foreignKeyName: "fk_project";
      columns: ["project_id"];
      referencedRelation: "projects";
      referencedColumns: ["id"];
    }
  ];
};
```

ë˜í•œ `projects` í…Œì´ë¸”ì˜ Row/Insert/Updateì— ì•„ë˜ í•„ë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤:
```typescript
// projects Rowì— ì¶”ê°€:
slack_channel_id: string | null;
slack_channel_name: string | null;
// projects Insert/Updateì— ì¶”ê°€ (optional):
slack_channel_id?: string | null;
slack_channel_name?: string | null;
```

### Project ì¸í„°í˜ì´ìŠ¤ í™•ì¥

ê¸°ì¡´ `Project` ì¸í„°í˜ì´ìŠ¤ì— ì±„ë„ ë§¤í•‘ í•„ë“œ ì¶”ê°€:

```typescript
// src/types/index.ts â€” Projectì— ì¶”ê°€
export interface Project {
  // ... ê¸°ì¡´ í•„ë“œ ...
  slackChannelId?: string;     // Slack ê¸°ë³¸ ì±„ë„ ID (ì˜ˆ: C0123456789)
  slackChannelName?: string;   // Slack ê¸°ë³¸ ì±„ë„ ì´ë¦„ (í‘œì‹œìš©, ì˜ˆ: "l10n-mir4")
}
```

### ê¸°ë³¸ ì œê³µ í…œí”Œë¦¿ (built-in)

í”„ë¡œì íŠ¸ ìƒì„± ì‹œ **DB íŠ¸ë¦¬ê±°**ë¡œ ìë™ ìƒì„± (ê¸°ì¡´ `email_templates`ì˜ `trg_seed_email_templates` íŒ¨í„´ê³¼ ë™ì¼):

```
*[{updateDateShort} ì—…ë°ì´íŠ¸ ì¼ì •]*

*í—¤ì¦ˆì—…:* {headsUp}
{{#if showIosReviewDate}}*iOS ì‹¬ì‚¬ì¼:* {iosReviewDate}
{{/if}}{{#if showPaidProductDate}}*ìœ ë£Œí™” ìƒí’ˆ í˜‘ì˜:* {paidProductDate}
{{/if}}
---

{table}

{{#if disclaimer}}---
_{disclaimer}_
{{/if}}
<https://azrael-002.vercel.app|Azraelì—ì„œ ìì„¸íˆ ë³´ê¸°>
```

## 6.2 Supabase í…Œì´ë¸”

### slack_user_tokens

```sql
CREATE TABLE slack_user_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT NOT NULL UNIQUE,          -- Supabase auth.users.id (TEXT íƒ€ì…)
  access_token TEXT NOT NULL,            -- Slack User OAuth Token (í‰ë¬¸)
  slack_user_id TEXT NOT NULL,           -- Slack ì‚¬ìš©ì ID (ì˜ˆ: U0123456)
  team_id TEXT NOT NULL,                 -- Slack Workspace ID (ì˜ˆ: T0123456)
  team_name TEXT,                        -- Slack Workspace ì´ë¦„ (í‘œì‹œìš©)
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### projects í…Œì´ë¸” í™•ì¥ (ì±„ë„ ë§¤í•‘)

`slack_channels` ë³„ë„ í…Œì´ë¸” ëŒ€ì‹ , ê¸°ì¡´ `projects` í…Œì´ë¸”ì— 2ê°œ ì»¬ëŸ¼ì„ ì¶”ê°€í•©ë‹ˆë‹¤ (í”„ë¡œì íŠ¸ë‹¹ ì±„ë„ 1:1 ê´€ê³„):

```sql
ALTER TABLE projects
  ADD COLUMN slack_channel_id TEXT,         -- Slack ê¸°ë³¸ ì±„ë„ ID
  ADD COLUMN slack_channel_name TEXT;       -- Slack ê¸°ë³¸ ì±„ë„ ì´ë¦„ (í‘œì‹œìš©)
```

> **ì„¤ê³„ ê²°ì •**: í”„ë¡œì íŠ¸ë‹¹ 1ê°œ ì±„ë„ë§Œ ë§¤í•‘í•˜ë¯€ë¡œ ë³„ë„ í…Œì´ë¸” ë¶ˆí•„ìš”. `projects` í…Œì´ë¸”ì— ì§ì ‘ ì €ì¥í•˜ì—¬ ì½”ë“œ ê°„ê²°í™”.

### slack_message_templates (ìŠ¬ë™ ë©”ì‹œì§€ í…œí”Œë¦¿)

```sql
CREATE TABLE slack_message_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id TEXT NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  name TEXT NOT NULL CHECK (char_length(name) <= 50),  -- ìµœëŒ€ 50ì
  body_template TEXT NOT NULL,           -- mrkdwn ë³¸ë¬¸ í…œí”Œë¦¿
  is_built_in BOOLEAN NOT NULL DEFAULT false,  -- NOT NULL: ëª…ì‹œì  ìƒíƒœ ë³´ì¥
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by TEXT,                       -- ìƒì„±ì ì´ë©”ì¼
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(project_id, name)              -- í”„ë¡œì íŠ¸ ë‚´ ì´ë¦„ ìœ ì¼ì„±
);
```

> **email_templatesì™€ì˜ ì°¨ì´**: `subject_template` ì»¬ëŸ¼ ì—†ìŒ (ìŠ¬ë™ ë©”ì‹œì§€ì— ì œëª© ê°œë… ì—†ìŒ).

### RLS ì •ì±…

ëª¨ë“  í…Œì´ë¸”ì˜ RLS ì •ì±…ì€ ê¸°ì¡´ íŒ¨í„´(migration 008)ì„ ë”°ë¦…ë‹ˆë‹¤:

```sql
-- íŒ¨í„´: auth.jwt() ->> 'email' (auth.email() ì•„ë‹˜)
-- íŒ¨í„´: ë³„ë„ INSERT(WITH CHECK) / UPDATE(USING) / DELETE(USING) ì •ì±…
-- í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸: 6ëª…

-- ì˜ˆì‹œ (slack_user_tokens):
ALTER TABLE slack_user_tokens ENABLE ROW LEVEL SECURITY;

-- SELECT: ë³¸ì¸ í† í°ë§Œ ì¡°íšŒ
CREATE POLICY "Users can read own slack_user_tokens"
  ON slack_user_tokens FOR SELECT
  TO authenticated
  USING (auth.uid()::text = user_id);

-- INSERT: í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì‚¬ìš©ìë§Œ + ë³¸ì¸ ë ˆì½”ë“œë§Œ
CREATE POLICY "Whitelisted users can insert slack_user_tokens"
  ON slack_user_tokens FOR INSERT
  TO authenticated
  WITH CHECK (
    auth.jwt() ->> 'email' IN (
      'jkcho@wemade.com', 'mine@wemade.com', 'srpark@wemade.com',
      'garden0130@wemade.com', 'hkkim@wemade.com', 'uzilay@gmail.com'
    )
    AND auth.uid()::text = user_id
  );

-- UPDATE: í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ + ë³¸ì¸ ë ˆì½”ë“œë§Œ
CREATE POLICY "Whitelisted users can update slack_user_tokens"
  ON slack_user_tokens FOR UPDATE
  TO authenticated
  USING (
    auth.jwt() ->> 'email' IN (
      'jkcho@wemade.com', 'mine@wemade.com', 'srpark@wemade.com',
      'garden0130@wemade.com', 'hkkim@wemade.com', 'uzilay@gmail.com'
    )
    AND auth.uid()::text = user_id
  );

-- DELETE: í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ + ë³¸ì¸ ë ˆì½”ë“œë§Œ
CREATE POLICY "Whitelisted users can delete slack_user_tokens"
  ON slack_user_tokens FOR DELETE
  TO authenticated
  USING (
    auth.jwt() ->> 'email' IN (
      'jkcho@wemade.com', 'mine@wemade.com', 'srpark@wemade.com',
      'garden0130@wemade.com', 'hkkim@wemade.com', 'uzilay@gmail.com'
    )
    AND auth.uid()::text = user_id
  );
```

> **ë™ì¼ íŒ¨í„´ì„ slack_message_templatesì—ë„ ì ìš©í•©ë‹ˆë‹¤.**
> slack_message_templatesì˜ SELECT ì •ì±…ì€ `USING (true)` (ëª¨ë“  ì¸ì¦ ì‚¬ìš©ì ì¡°íšŒ ê°€ëŠ¥).
> slack_message_templatesì˜ DELETE ì •ì±…ì— `AND is_built_in = false` ì¡°ê±´ ì¶”ê°€ (email_templates íŒ¨í„´ ë™ì¼).
>
> **Service Role Keyì™€ RLS**: `slack-oauth-callback` Edge Functionì˜ í† í° UPSERTëŠ” Service Role Keyë¡œ ìˆ˜í–‰í•˜ë¯€ë¡œ RLSê°€ bypassë©ë‹ˆë‹¤. ìœ„ RLS ì •ì±…ì€ **defense-in-depth**ë¡œ, í”„ë¡ íŠ¸ì—”ë“œ ì§ì ‘ ì ‘ê·¼ ì‹œ ë³´í˜¸ ì—­í• ì…ë‹ˆë‹¤. Service Role KeyëŠ” Edge Function í™˜ê²½ë³€ìˆ˜ë¡œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë©° í´ë¼ì´ì–¸íŠ¸ì— ë…¸ì¶œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

## 6.3 Edge Functions

### slack-send

```typescript
// supabase/functions/slack-send/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    const { channelId, message, userId, threadTs } = await req.json();

    // Supabase í´ë¼ì´ì–¸íŠ¸ (Service Role: RLS ë¬´ì‹œ)
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL')!,
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
    );

    // 1. ì‚¬ìš©ì í† í° ì¡°íšŒ
    const { data: tokenData, error: tokenError } = await supabase
      .from('slack_user_tokens')
      .select('access_token')
      .eq('user_id', userId)
      .single();

    if (tokenError || !tokenData) {
      return new Response(
        JSON.stringify({
          success: false,
          error: 'Slack ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤. ì„¤ì • > Slackì—ì„œ ì—°ë™í•´ì£¼ì„¸ìš”.',
          errorCode: 'TOKEN_NOT_FOUND',
        }),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 401 }
      );
    }

    // 2. Slack API í˜¸ì¶œ (chat.postMessage)
    // chat.postMessageëŠ” text í•„ë“œë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ mrkdwn íŒŒì‹±í•˜ë¯€ë¡œ mrkdwn íŒŒë¼ë¯¸í„° ë¶ˆí•„ìš”
    const slackBody: Record<string, unknown> = {
      channel: channelId,
      text: message,
    };
    if (threadTs) {
      slackBody.thread_ts = threadTs;
    }

    const slackResponse = await fetch('https://slack.com/api/chat.postMessage', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${tokenData.access_token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(slackBody),
    });

    const slackResult = await slackResponse.json();

    // 3. í† í° ë¬´íš¨í™” ì—ëŸ¬ ì‹œ ìë™ ì‚­ì œ
    if (slackResult.error === 'token_revoked' || slackResult.error === 'invalid_auth') {
      await supabase
        .from('slack_user_tokens')
        .delete()
        .eq('user_id', userId);

      return new Response(
        JSON.stringify({
          success: false,
          error: 'Slack ì—°ë™ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ ë‹¤ì‹œ ì—°ë™í•´ì£¼ì„¸ìš”.',
          errorCode: 'TOKEN_INVALID',
        }),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 401 }
      );
    }

    // 4. Rate limit ì—ëŸ¬
    if (slackResult.error === 'ratelimited') {
      const retryAfter = parseInt(slackResponse.headers.get('Retry-After') || '60', 10);
      return new Response(
        JSON.stringify({
          success: false,
          error: `ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ${retryAfter}ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`,
          errorCode: 'RATE_LIMITED',
          retryAfter,
        }),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 429 }
      );
    }

    // 5. ê¸°íƒ€ Slack API ì—ëŸ¬
    if (!slackResult.ok) {
      // not_in_channel ì—ëŸ¬ íŠ¹ë³„ ì²˜ë¦¬
      if (slackResult.error === 'not_in_channel') {
        return new Response(
          JSON.stringify({
            success: false,
            error: 'í•´ë‹¹ ì±„ë„ì— ì°¸ì—¬í•˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. Slackì—ì„œ ì±„ë„ì— ë¨¼ì € ì°¸ì—¬í•´ì£¼ì„¸ìš”.',
            errorCode: 'NOT_IN_CHANNEL',
          }),
          { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 403 }
        );
      }

      // channel_not_found ì—ëŸ¬ íŠ¹ë³„ ì²˜ë¦¬
      if (slackResult.error === 'channel_not_found') {
        return new Response(
          JSON.stringify({
            success: false,
            error: 'ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì±„ë„ì„ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.',
            errorCode: 'CHANNEL_NOT_FOUND',
          }),
          { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 404 }
        );
      }

      return new Response(
        JSON.stringify({
          success: false,
          error: `ìŠ¬ë™ ë°œì‹  ì‹¤íŒ¨: ${slackResult.error}`,
          errorCode: slackResult.error,
        }),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 400 }
      );
    }

    // 6. ì„±ê³µ
    return new Response(
      JSON.stringify({
        success: true,
        messageTs: slackResult.ts,
      }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );

  } catch (error) {
    console.error('slack-send error:', error);
    return new Response(
      JSON.stringify({
        success: false,
        error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
        errorCode: 'INTERNAL_ERROR',
      }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 500 }
    );
  }
});
```

### slack-channels

```typescript
// supabase/functions/slack-channels/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

// POST ì‚¬ìš©: bodyì— userId ì „ë‹¬ (ê¸°ì¡´ JIRA Edge Functionê³¼ ë™ì¼ íŒ¨í„´)
serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    const { userId } = await req.json();

    const supabase = createClient(
      Deno.env.get('SUPABASE_URL')!,
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
    );

    // 1. ì‚¬ìš©ì í† í° ì¡°íšŒ
    const { data: tokenData, error: tokenError } = await supabase
      .from('slack_user_tokens')
      .select('access_token')
      .eq('user_id', userId)
      .single();

    if (tokenError || !tokenData) {
      return new Response(
        JSON.stringify({
          success: false,
          error: 'Slack ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤.',
          errorCode: 'TOKEN_NOT_FOUND',
        }),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 401 }
      );
    }

    // 2. ê³µê°œ ì±„ë„ + ë¹„ê³µê°œ ì±„ë„ ì¡°íšŒ (ë³„ë„ í˜¸ì¶œ)
    // Promise.allSettled: í•œìª½ ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ì‹œì—ë„ ë‹¤ë¥¸ ìª½ ê²°ê³¼ë¥¼ í™œìš©
    const [publicSettled, privateSettled] = await Promise.allSettled([
      fetch(
        'https://slack.com/api/conversations.list?types=public_channel&limit=200&exclude_archived=true',
        { headers: { 'Authorization': `Bearer ${tokenData.access_token}` } }
      ),
      fetch(
        'https://slack.com/api/conversations.list?types=private_channel&limit=200&exclude_archived=true',
        { headers: { 'Authorization': `Bearer ${tokenData.access_token}` } }
      ),
    ]);

    // ê³µê°œ ì±„ë„ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ì „ì²´ ì—ëŸ¬
    if (publicSettled.status === 'rejected') {
      console.error('Public channels fetch failed:', publicSettled.reason);
      return new Response(
        JSON.stringify({ success: false, error: 'ì±„ë„ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨', errorCode: 'NETWORK_ERROR' }),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 500 }
      );
    }

    const publicResponse = publicSettled.value;
    const publicResult = await publicResponse.json();
    const privateResponse = privateSettled.status === 'fulfilled' ? privateSettled.value : null;
    const privateResult = privateResponse ? await privateResponse.json() : { ok: false };

    // 3. í† í° ë¬´íš¨í™” ì²´í¬ (ê³µê°œ ì±„ë„ ì‘ë‹µ ê¸°ì¤€)
    if (publicResult.error === 'token_revoked' || publicResult.error === 'invalid_auth') {
      await supabase
        .from('slack_user_tokens')
        .delete()
        .eq('user_id', userId);

      return new Response(
        JSON.stringify({
          success: false,
          error: 'Slack ì—°ë™ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì—°ë™í•´ì£¼ì„¸ìš”.',
          errorCode: 'TOKEN_INVALID',
        }),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 401 }
      );
    }

    // 4. Rate limit ì²´í¬
    if (publicResult.error === 'ratelimited') {
      const retryAfter = parseInt(publicResponse.headers.get('Retry-After') || '60', 10);
      return new Response(
        JSON.stringify({
          success: false,
          error: `ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ${retryAfter}ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`,
          errorCode: 'RATE_LIMITED',
          retryAfter,
        }),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 429 }
      );
    }

    // 5. ê³µê°œ ì±„ë„ ì‘ë‹µ ê²€ì¦
    if (!publicResult.ok) {
      return new Response(
        JSON.stringify({
          success: false,
          error: `ì±„ë„ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${publicResult.error}`,
          errorCode: publicResult.error,
        }),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 400 }
      );
    }

    // 6. ì±„ë„ ëª©ë¡ í•©ì¹˜ê¸° (ì´ë¦„ìˆœ ì •ë ¬)
    // ë¹„ê³µê°œ ì±„ë„ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ê³µê°œ ì±„ë„ë§Œ ë°˜í™˜ (graceful degradation) + warning
    const publicChannels = (publicResult.channels || []).map((ch: any) => ({
      id: ch.id,
      name: ch.name,
      isPrivate: false,
    }));

    const privateAvailable = privateResult.ok;
    if (!privateAvailable) {
      console.warn('Private channels unavailable:', privateResult.error || 'fetch failed');
    }

    const privateChannels = privateAvailable
      ? (privateResult.channels || []).map((ch: any) => ({
          id: ch.id,
          name: ch.name,
          isPrivate: true,
        }))
      : [];  // ë¹„ê³µê°œ ì±„ë„ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ë¹ˆ ë°°ì—´

    const channels = [...publicChannels, ...privateChannels]
      .sort((a, b) => a.name.localeCompare(b.name));

    return new Response(
      JSON.stringify({
        success: true,
        channels,
        warning: privateAvailable ? null : 'PRIVATE_CHANNELS_UNAVAILABLE',
      }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );

  } catch (error) {
    console.error('slack-channels error:', error);
    return new Response(
      JSON.stringify({
        success: false,
        error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
        errorCode: 'INTERNAL_ERROR',
      }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 500 }
    );
  }
});
```

### slack-oauth-callback

```typescript
// supabase/functions/slack-oauth-callback/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

serve(async (req) => {
  // CORS ë¶ˆí•„ìš” (ë¸Œë¼ìš°ì € ë¦¬ë‹¤ì´ë ‰íŠ¸ë¡œ ì§ì ‘ í˜¸ì¶œë¨)

  try {
    const url = new URL(req.url);
    const code = url.searchParams.get('code');
    const state = url.searchParams.get('state');
    const error = url.searchParams.get('error');

    // 1. ì‚¬ìš©ìê°€ OAuth ê±°ë¶€í•œ ê²½ìš°
    if (error) {
      return new Response(renderErrorHtml('Slack ì—°ë™ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.'), {
        headers: { 'Content-Type': 'text/html; charset=utf-8' },
      });
    }

    // 2. code ëˆ„ë½
    if (!code) {
      return new Response(renderErrorHtml('ì¸ì¦ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'), {
        headers: { 'Content-Type': 'text/html; charset=utf-8' },
      });
    }

    // 3. stateì—ì„œ supabaseUid ì¶”ì¶œ
    //    state í˜•ì‹: "{csrf}:{supabaseUid}" (ë‘˜ ë‹¤ UUIDì´ë¯€ë¡œ ':'ë¥¼ í¬í•¨í•˜ì§€ ì•ŠìŒ)
    const [csrf, supabaseUid] = (state || '').split(':', 2);

    if (!csrf || !supabaseUid) {
      return new Response(renderErrorHtml('ì¸ì¦ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'), {
        headers: { 'Content-Type': 'text/html; charset=utf-8' },
      });
    }

    // 4. code â†’ access_token êµí™˜ (oauth.v2.access)
    const tokenResponse = await fetch('https://slack.com/api/oauth.v2.access', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        client_id: Deno.env.get('SLACK_CLIENT_ID')!,
        client_secret: Deno.env.get('SLACK_CLIENT_SECRET')!,
        code,
        redirect_uri: Deno.env.get('SLACK_REDIRECT_URI')!,
      }),
    });

    const tokenResult = await tokenResponse.json();

    if (!tokenResult.ok) {
      console.error('OAuth token exchange failed:', tokenResult.error);
      return new Response(
        renderErrorHtml(`Slack ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${tokenResult.error}`),
        { headers: { 'Content-Type': 'text/html; charset=utf-8' } }
      );
    }

    // 5. User Token ì¶”ì¶œ
    // user_scope ì‚¬ìš© ì‹œ: tokenResult.authed_user ì— í† í° ì •ë³´ê°€ ìˆìŒ
    const authedUser = tokenResult.authed_user;
    if (!authedUser?.access_token) {
      console.error('No user token in OAuth response:', JSON.stringify(tokenResult));
      console.error('Possible cause: Using scope instead of user_scope in OAuth URL');
      return new Response(
        renderErrorHtml('Slack ì—°ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'),
        { headers: { 'Content-Type': 'text/html; charset=utf-8' } }
      );
    }

    // 6. DBì— í† í° UPSERT (user_id = Supabase UID)
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL')!,
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
    );

    const { error: dbError } = await supabase
      .from('slack_user_tokens')
      .upsert({
        user_id: supabaseUid,              // â† Supabase UID (stateì—ì„œ ì¶”ì¶œ)
        access_token: authedUser.access_token,
        slack_user_id: authedUser.id,       // Slack User IDëŠ” ë³„ë„ ì»¬ëŸ¼ì— ì €ì¥
        team_id: tokenResult.team?.id || '',
        team_name: tokenResult.team?.name || '',
        updated_at: new Date().toISOString(),
      }, { onConflict: 'user_id' });

    if (dbError) {
      console.error('DB upsert failed:', dbError);
      return new Response(
        renderErrorHtml('í† í° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'),
        { headers: { 'Content-Type': 'text/html; charset=utf-8' } }
      );
    }

    // 7. ì„±ê³µ HTML ì‘ë‹µ (í´ë¼ì´ì–¸íŠ¸ì—ì„œ CSRF ê²€ì¦ + postMessage)
    return new Response(
      renderSuccessHtml(csrf, supabaseUid),
      { headers: { 'Content-Type': 'text/html; charset=utf-8' } }
    );

  } catch (error) {
    console.error('slack-oauth-callback error:', error);
    return new Response(
      renderErrorHtml('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'),
      { headers: { 'Content-Type': 'text/html; charset=utf-8' } }
    );
  }
});

/**
 * ì„±ê³µ ì‹œ HTML (í´ë¼ì´ì–¸íŠ¸ì—ì„œ CSRF ê²€ì¦ í›„ postMessage)
 * XSS ë°©ì§€: data-* ì†ì„±ìœ¼ë¡œ ê°’ ì „ë‹¬ (template literal ì§ì ‘ ì‚½ì… ê¸ˆì§€)
 */
function renderSuccessHtml(csrf: string, userId: string): string {
  const appOrigin = Deno.env.get('APP_ORIGIN') || 'https://azrael-002.vercel.app';

  // HTML entity escapeë¡œ XSS ë°©ì§€
  const escape = (s: string) => s.replace(/[&<>"']/g, (c) =>
    ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c] || c)
  );
  const escapedCsrf = escape(csrf);
  const escapedUserId = escape(userId);
  const escapedOrigin = escape(appOrigin);

  return `<!DOCTYPE html>
<html>
<head><title>Slack ì—°ë™</title></head>
<body>
  <p>Slack ì—°ë™ ì²˜ë¦¬ ì¤‘...</p>
  <div id="oauth-config" data-csrf="${escapedCsrf}" data-user-id="${escapedUserId}" data-app-origin="${escapedOrigin}" style="display:none"></div>
  <script>
    (function() {
      var configEl = document.getElementById('oauth-config');
      var urlCsrf = configEl.getAttribute('data-csrf');
      var userId = configEl.getAttribute('data-user-id');
      var savedCsrf = localStorage.getItem('slack_oauth_state');

      if (!savedCsrf || savedCsrf !== urlCsrf) {
        document.body.innerHTML = '<p>ë³´ì•ˆ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
        return;
      }

      localStorage.removeItem('slack_oauth_state');

      if (window.opener) {
        var targetOrigin = configEl.getAttribute('data-app-origin') || 'https://azrael-002.vercel.app';
        window.opener.postMessage(
          { type: 'SLACK_OAUTH_SUCCESS', userId: userId },
          targetOrigin
        );
      }

      document.body.innerHTML = '<p>ì—°ë™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ì°½ì€ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.</p>';
      setTimeout(function() { window.close(); }, 1500);
    })();
  </script>
</body>
</html>`;
}

/**
 * ì—ëŸ¬ ì‹œ HTML
 * XSS ë°©ì§€: ì—ëŸ¬ ë©”ì‹œì§€ë„ entity escape
 */
function renderErrorHtml(message: string): string {
  const escaped = message.replace(/[&<>"']/g, (c) =>
    ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c] || c)
  );
  return `<!DOCTYPE html>
<html>
<head><title>Slack ì—°ë™ ì‹¤íŒ¨</title></head>
<body>
  <p>${escaped}</p>
  <p>ì´ ì°½ì„ ë‹«ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
</body>
</html>`;
}
```

## 6.4 ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°

```
src/components/
â”œâ”€ SlackSendModal.tsx              # ìŠ¬ë™ ë°œì‹  ëª¨ë‹¬ (lazy load: MainScreen.tsxì—ì„œ)
â””â”€ settings/
   â””â”€ SettingsSlackTab.tsx         # ì„¤ì • > Slack íƒ­ (ì—°ë™/ì±„ë„ë§¤í•‘/í…œí”Œë¦¿)

src/lib/slack/
â”œâ”€ formatter.ts                    # mrkdwn í¬ë§·í„° (í…Œì´ë¸” + Disclaimer ë³€í™˜)
â””â”€ slackGenerator.ts               # ìŠ¬ë™ ë©”ì‹œì§€ ìƒì„± íŒŒì´í”„ë¼ì¸

src/lib/api/
â””â”€ slack.ts                        # Slack ê´€ë ¨ API í†µí•© (send, channels, tokens, templates)

src/hooks/
â”œâ”€ useSlackTokenStatus.ts          # React Query í›… (í† í° ì¡´ì¬ ì—¬ë¶€ ì¡°íšŒ)
â””â”€ useSlackTemplates.ts            # React Query í›… (í…œí”Œë¦¿ CRUD + ìºì‹±)
```

> **API íŒŒì¼ í†µí•©**: ì´ë©”ì¼ APIëŠ” `emailTemplates.ts` 1íŒŒì¼ì´ë¯€ë¡œ,
> ìŠ¬ë™ë„ `slack.ts` 1íŒŒì¼ì— send/channels/tokens/templates í•¨ìˆ˜ë¥¼ ëª¨ë‘ í¬í•¨í•©ë‹ˆë‹¤.
> ë‹¤ë§Œ íŒŒì¼ì´ ì§€ë‚˜ì¹˜ê²Œ ê¸¸ì–´ì§ˆ ê²½ìš°(300ì¤„ ì´ˆê³¼), `slackTokens.ts`ë¥¼ ë¶„ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### DBâ†’í”„ë¡ íŠ¸ì—”ë“œ ë§¤í•‘ í•¨ìˆ˜

ê¸°ì¡´ `mapToProject()`, `mapToEmailTemplate()` íŒ¨í„´ê³¼ ë™ì¼í•˜ê²Œ snake_case â†’ camelCase ë§¤í•‘ í•¨ìˆ˜ë¥¼ `slack.ts`ì— ë°°ì¹˜í•©ë‹ˆë‹¤:

```typescript
// src/lib/api/slack.ts â€” DB Row â†’ í”„ë¡ íŠ¸ì—”ë“œ íƒ€ì… ë§¤í•‘
function mapToSlackMessageTemplate(
  row: Database['public']['Tables']['slack_message_templates']['Row']
): SlackMessageTemplate {
  return {
    id: row.id,
    projectId: row.project_id,
    name: row.name,
    bodyTemplate: row.body_template,
    isBuiltIn: row.is_built_in,
    createdAt: row.created_at,
    createdBy: row.created_by,
    updatedAt: row.updated_at,
  };
}
```

### SlackSendModal lazy load

```typescript
// MainScreen.tsx (ê¸°ì¡´ EmailGeneratorModal, JiraPreviewModalê³¼ ë™ì¼ íŒ¨í„´)
const SlackSendModal = lazy(() => import('./SlackSendModal').then(m => ({ default: m.SlackSendModal })));

// ì‚¬ìš© ì‹œ
<Suspense fallback={null}>
  {showSlackModal && (
    <SlackSendModal
      isOpen={showSlackModal}
      onClose={() => setShowSlackModal(false)}
      project={currentProject}
      calculationResult={calculationResult}
      currentUserId={currentUserId}
    />
  )}
</Suspense>
```

### API í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ (src/lib/api/slack.ts)

```typescript
// === Token ===
export async function checkSlackTokenStatus(userId: string): Promise<boolean>;
export async function deleteSlackToken(userId: string): Promise<void>;

// === Channels (Edge Function í˜¸ì¶œ) ===
export async function fetchSlackChannels(userId: string): Promise<SlackChannel[]>;

// === Channel Mapping (projects í…Œì´ë¸” ì—…ë°ì´íŠ¸) ===
// ìœ ë‹ˆì˜¨ íƒ€ì…: ì±„ë„ í•´ì œ(null, null) ë˜ëŠ” ì±„ë„ ì„¤ì •(string, string) â€” í•œìª½ë§Œ nullì¸ ìƒíƒœ ë°©ì§€
export async function saveChannelMapping(
  projectId: string, channel: { id: string; name: string } | null
): Promise<void>;

// === Message Send (Edge Function í˜¸ì¶œ) ===
export async function sendSlackMessage(request: SlackSendRequest): Promise<SlackSendResponse>;

// === Templates (CRUD) ===
export async function fetchSlackTemplates(projectId: string): Promise<SlackMessageTemplate[]>;
export async function fetchSlackTemplate(id: string): Promise<SlackMessageTemplate>;
// isBuiltInì€ Omitìœ¼ë¡œ ì œì™¸: DB DEFAULT false ì ìš© + INSERT RLSì—ì„œ is_built_in=false ê°•ì œ (í”„ë¡ íŠ¸ì—”ë“œì—ì„œ true ì„¤ì • ë¶ˆê°€)
export async function createSlackTemplate(template: Omit<SlackMessageTemplate, 'id' | 'createdAt' | 'updatedAt' | 'createdBy' | 'isBuiltIn'>): Promise<SlackMessageTemplate>;
export async function updateSlackTemplate(id: string, updates: Partial<SlackMessageTemplate>): Promise<SlackMessageTemplate>;
export async function deleteSlackTemplate(id: string): Promise<void>;
```

> **Edge Function í˜¸ì¶œ íŒ¨í„´**: ê¸°ì¡´ JIRA ì½”ë“œì™€ ë™ì¼í•˜ê²Œ `fetch()` ì‚¬ìš©.
> ```typescript
> const response = await fetch(
>   `${supabaseUrl}/functions/v1/slack-send`,
>   {
>     method: 'POST',
>     headers: {
>       'Authorization': `Bearer ${supabaseAnonKey}`,
>       'Content-Type': 'application/json',
>     },
>     body: JSON.stringify(request),
>   }
> );
> ```

### React Query í›…

**useSlackTemplates.ts** â€” ê¸°ì¡´ `useEmailTemplates.ts` íŒ¨í„´ê³¼ ë™ì¼í•˜ê²Œ 4ê°œ í›… export:

```typescript
export function useSlackTemplates(projectId: string);        // ëª©ë¡ ì¡°íšŒ, queryKey: ['slack-templates', projectId]
export function useCreateSlackTemplate();                     // ìƒì„±
export function useUpdateSlackTemplate();                     // ìˆ˜ì •
export function useDeleteSlackTemplate();                     // ì‚­ì œ
// ëª¨ë“  mutationì˜ onSuccessì—ì„œ queryClient.invalidateQueries({ queryKey: ['slack-templates', projectId] })
// projectIdëŠ” mutation í˜¸ì¶œ ì‹œ ì»¨í…ìŠ¤íŠ¸ì—ì„œ ê°€ì ¸ì˜´ (useSlackTemplatesì™€ ë™ì¼ projectId)
```

**useSlackTokenStatus.ts** â€” í† í° ì¡´ì¬ ì—¬ë¶€ ì¡°íšŒ (Â§4.1ì—ì„œ ì •ì˜):

```typescript
export function useSlackTokenStatus(userId: string | undefined);  // boolean ë°˜í™˜
```

**ì±„ë„ ëª©ë¡ ì¡°íšŒ** â€” SlackSendModal ë° SettingsSlackTab ë‚´ë¶€ì—ì„œ ì¸ë¼ì¸ `useQuery` ì‚¬ìš©:

```typescript
// ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì—ì„œ ì§ì ‘ ì‚¬ìš© (ë³„ë„ í›… íŒŒì¼ ë¶ˆí•„ìš”)
const { data: channels, isLoading, error, refetch } = useQuery({
  queryKey: ['slack-channels', userId],
  queryFn: () => fetchSlackChannels(userId!),
  enabled: !!userId,
  staleTime: 2 * 60 * 1000,  // 2ë¶„ (ì±„ë„ ëª©ë¡ì€ ìì£¼ ë³€ê²½ë˜ì§€ ì•ŠìŒ)
});
```

## 6.5 ìŠ¬ë™ ë©”ì‹œì§€ ìƒì„± íŒŒì´í”„ë¼ì¸

```typescript
// src/lib/slack/slackGenerator.ts

// import ê²½ë¡œ:
// formatEmailDate, formatUpdateDateShort: '../email/formatters' (ê¸°ì¡´ ì´ë©”ì¼ ê³µìš© í•¨ìˆ˜)
// getEntriesByTableType: '../email/generator' (ì´ë©”ì¼/ìŠ¬ë™ ê³µìš©)
// substituteDisclaimerVariables: '../email/generator'
// renderTemplate: '../email/parser' (ê¸°ì¡´ í…œí”Œë¦¿ ì—”ì§„)
import { formatEmailDate, formatUpdateDateShort, getEntriesByTableType } from '../email/formatters';
import { substituteDisclaimerVariables } from '../email/generator';
import { renderTemplate } from '../email/parser';

/**
 * ìŠ¬ë™ ë©”ì‹œì§€ ìƒì„± íŒŒì´í”„ë¼ì¸
 *
 * íŒŒì´í”„ë¼ì¸ ìˆœì„œ:
 *   1. ë‚ ì§œ í¬ë§·íŒ… (ê¸°ì¡´ formatEmailDate, formatUpdateDateShort ì¬ì‚¬ìš©)
 *   2. í…Œì´ë¸” mrkdwn ìƒì„± (formatTableMrkdwn)
 *   3. Disclaimer mrkdwn ë³€í™˜ (convertDisclaimerToMrkdwn)
 *   4. ë³€ìˆ˜ ì¹˜í™˜ìš© ì»¨í…ìŠ¤íŠ¸ êµ¬ì„± (ì´ë©”ì¼ê³¼ ë™ì¼ êµ¬ì¡°)
 *   5. í…œí”Œë¦¿ ë Œë”ë§ (ê¸°ì¡´ renderTemplate ì¬ì‚¬ìš©)
 */

export interface GenerateSlackMessageDeps {
  template: SlackMessageTemplate;
  project: Project;
  calcResult: CalculationResult;
}

export function generateSlackMessage(
  tableType: TableType,
  deps: GenerateSlackMessageDeps,
): string {
  const { template, project, calcResult } = deps;

  // 1. ë‚ ì§œ í¬ë§·íŒ… (ê¸°ì¡´ ì´ë©”ì¼/ìŠ¬ë™ ê³µìš© í•¨ìˆ˜ ì¬ì‚¬ìš©)
  const updateDate = formatEmailDate(calcResult.updateDate);
  const updateDateShort = formatUpdateDateShort(calcResult.updateDate);  // MM-DD í˜•ì‹
  const headsUp = formatEmailDate(calcResult.headsUpDate);
  const iosReviewDate = calcResult.iosReviewDate
    ? formatEmailDate(calcResult.iosReviewDate) : null;
  const paidProductDate = calcResult.paidProductDate
    ? formatEmailDate(calcResult.paidProductDate) : null;

  // 2. í…Œì´ë¸” mrkdwn ìƒì„±
  // getEntriesByTableType: ê¸°ì¡´ src/lib/email/generator.tsì—ì„œ import (ì´ë©”ì¼/ìŠ¬ë™ ê³µìš©)
  const entries = getEntriesByTableType(calcResult, tableType);
  const tableMrkdwn = formatTableMrkdwn(entries, tableType);

  // 3. Disclaimer ë³€ìˆ˜ ì¹˜í™˜ + mrkdwn ë³€í™˜
  // emailGenerator.tsì™€ ë™ì¼ íŒ¨í„´: calcResultê°€ { updateDate, headsUpDate, ... } shapeê³¼ í˜¸í™˜ë˜ë¯€ë¡œ ì§ì ‘ ì „ë‹¬
  const disclaimerWithVars = substituteDisclaimerVariables(
    project.disclaimer, calcResult, formatEmailDate
  );
  const disclaimerMrkdwn = convertDisclaimerToMrkdwn(disclaimerWithVars);

  // 4. ì»¨í…ìŠ¤íŠ¸ êµ¬ì„± (ì´ë©”ì¼ê³¼ ë™ì¼ êµ¬ì¡°)
  // TemplateContext: src/lib/email/generator.tsì—ì„œ exportëœ íƒ€ì… (ì´ë©”ì¼/ìŠ¬ë™ ê³µìš©)
  // { updateDate, updateDateShort, headsUp, iosReviewDate, table, disclaimer,
  //   projectName, showIosReviewDate, paidProductDate, showPaidProductDate }
  const context: TemplateContext = {
    updateDate,
    updateDateShort,
    headsUp,
    iosReviewDate,
    table: tableMrkdwn,
    disclaimer: disclaimerMrkdwn || null,
    projectName: project.name,
    showIosReviewDate: project.showIosReviewDate && iosReviewDate != null,
    paidProductDate,
    showPaidProductDate: project.showPaidProductDate && paidProductDate != null,
  };

  // 5. í…œí”Œë¦¿ ë Œë”ë§ (ê¸°ì¡´ renderTemplate ì¬ì‚¬ìš©)
  return renderTemplate(template.bodyTemplate, context);
}
```

### formatTableMrkdwn êµ¬í˜„

ìŠ¬ë™ì€ HTML í…Œì´ë¸”ì„ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, í…ìŠ¤íŠ¸ ê¸°ë°˜ í¬ë§·íŒ…ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

**í…Œì´ë¸” íƒ€ì…ë³„ ì¶œë ¥ í˜•ì‹**:

ëª¨ë“  í…Œì´ë¸”(T1/T2/T3)ì—ì„œ ë™ì¼í•œ í˜•ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì„¤ëª…(description), ë‹´ë‹¹ì(assignee), JIRA ì„¤ëª… ë“± ë¶€ê°€ ì •ë³´ëŠ” mrkdwnì— í¬í•¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (ê°„ê²°ì„± ìš°ì„ ):

```
*[ì¼ì • ìš”ì•½]*
1. ì •ê¸°: 01/10(ê¸ˆ) 09:00 ~ 01/15(ìˆ˜) 18:00
2. 1ì°¨: 01/20(ì›”) 09:00 ~ 01/25(í† ) 18:00
   2.1. ë²ˆì—­: 01/20(ì›”) 09:00 ~ 01/22(ìˆ˜) 18:00
   2.2. ê²€ìˆ˜: 01/23(ëª©) 09:00 ~ 01/25(í† ) 18:00
3. 2ì°¨: 02/01(ì¼) 09:00 ~ 02/05(ëª©) 18:00
```

- ì¸ì `entries`ëŠ” `getEntriesByTableType()`ì´ ë°˜í™˜í•œ **í‰íƒ„í™” ë°°ì—´**. ê° ì—”íŠ¸ë¦¬ì˜ íƒ€ì…: `{ index: number, stageName: string, startDatetime: string, endDatetime: string, parentId: string | null }` (ê¸°ì¡´ `schedule_entries` í…Œì´ë¸”ì˜ ì»¬ëŸ¼ ê¸°ë°˜). `parentId`ê°€ ì¡´ì¬í•˜ë©´ ìì‹ ì—”íŠ¸ë¦¬ë¡œ íŒë‹¨.
- **ë¹ˆ ë°°ì—´ ì²˜ë¦¬**: `entries`ê°€ ë¹ˆ ë°°ì—´ì´ë©´ `"(í•´ë‹¹ í…Œì´ë¸”ì— ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤)"` ë¬¸ìì—´ì„ ë°˜í™˜
- ë¶€ëª¨ ì—”íŠ¸ë¦¬ (`parentId` ì—†ìŒ): `N. {name}: {startDate} ~ {endDate}`
- ìì‹ ì—”íŠ¸ë¦¬ (`parentId` ìˆìŒ): `   N.M. {name}: {startDate} ~ {endDate}` (ì¸ë´íŠ¸ 3ì¹¸)
- **entry.index ë²ˆí˜¸ ì²´ê³„**: `entry.index`ëŠ” ì´ë¯¸ ì†Œìˆ˜ì ì„ í¬í•¨í•œ ê°’ì…ë‹ˆë‹¤ (ì˜ˆ: 1, 1.1, 1.2, 2). `String(entry.index)`ë¡œ ì§ì ‘ ì‚¬ìš©í•©ë‹ˆë‹¤. ê¸°ì¡´ `formatters.ts`ì˜ JSDoc (`[{ index: 1, children: [{ index: 1.1 }] }]`)ì—ì„œ í™•ì¸ëœ ì‚¬í•­ì…ë‹ˆë‹¤.
- ë‚ ì§œ í˜•ì‹: ê¸°ì¡´ `formatTableDate()` í•¨ìˆ˜ ì‚¬ìš© (`MM/DD(ìš”ì¼) HH:MM` â€” `src/lib/businessDays.ts`)
- ì¶œë ¥ ìƒë‹¨ì— `*[ì¼ì • ìš”ì•½]*` ì œëª©ì„ ìë™ í¬í•¨
- **ë²ˆí˜¸ ëª©ë¡ ë Œë”ë§**: mrkdwnì—ì„œ `1.` ê°™ì€ ìˆ«ì+ì  íŒ¨í„´ì€ Slackì´ ìë™ìœ¼ë¡œ ë²ˆí˜¸ ëª©ë¡ìœ¼ë¡œ ë Œë”ë§í•©ë‹ˆë‹¤. ë“¤ì—¬ì“°ê¸°ëœ í•­ëª©(`   2.1.`)ë„ ì¤‘ì²© ëª©ë¡ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.

### convertDisclaimerToMrkdwn êµ¬í˜„

```typescript
/**
 * Disclaimer ì»¤ìŠ¤í…€ ì„œì‹ íƒœê·¸ë¥¼ mrkdwnìœ¼ë¡œ ë³€í™˜
 * Â§2.3 ë³€í™˜ ê·œì¹™ ì ìš©
 *
 * ì¤‘ì²© íƒœê·¸ ì²˜ë¦¬: ìˆœì°¨ replaceì´ë¯€ë¡œ ì™¸ë¶€â†’ë‚´ë¶€ ìˆœìœ¼ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.
 * ì˜ˆ: `<b><r>text</r></b>` â†’ `*<r>text</r>*` â†’ `*text*` (ìµœì¢… Bold)
 * ì¤‘ì²© ì‚¬ìš©ì„ ê¶Œì¥í•˜ì§€ ì•Šì§€ë§Œ, ë™ì‘ì€ ì˜¬ë°”ë¦…ë‹ˆë‹¤.
 */
export function convertDisclaimerToMrkdwn(disclaimer: string): string {
  if (!disclaimer) return '';
  return disclaimer
    .replace(/<b>([\s\S]*?)<\/b>/g, '*$1*')     // Bold
    .replace(/<r>([\s\S]*?)<\/r>/g, '$1')       // Red â†’ íƒœê·¸ ì œê±° (mrkdwn ìƒ‰ìƒ ë¯¸ì§€ì›)
    .replace(/<g>([\s\S]*?)<\/g>/g, '$1')       // Green â†’ íƒœê·¸ ì œê±°
    .replace(/<bl>([\s\S]*?)<\/bl>/g, '$1')     // Blue â†’ íƒœê·¸ ì œê±°
    .replace(/<u>([\s\S]*?)<\/u>/g, '$1');      // Underline â†’ íƒœê·¸ ì œê±°
}
```

## 6.6 Rate Limit ì—ëŸ¬ ì²˜ë¦¬

Rate Limit ì—ëŸ¬(`RATE_LIMITED`) ë°œìƒ ì‹œ ìë™ ì¬ì‹œë„ ì—†ì´ ì¦‰ì‹œ ì—ëŸ¬ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. ì‚¬ìš©ìê°€ `retryAfter` ì‹œê°„ ê²½ê³¼ í›„ ìˆ˜ë™ìœ¼ë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤.

```typescript
// src/lib/api/slack.ts

async function sendSlackMessage(
  request: SlackSendRequest
): Promise<SlackSendResponse> {
  const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

  try {
    const response = await fetch(`${supabaseUrl}/functions/v1/slack-send`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${supabaseAnonKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(request),
    });

    return response.json();
  } catch (error) {
    // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ (ì˜¤í”„ë¼ì¸, DNS ì‹¤íŒ¨, íƒ€ì„ì•„ì›ƒ ë“±)
    return {
      success: false,
      error: 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.',
      errorCode: 'NETWORK_ERROR',
    };
  }
}
```

---

# 7. ì—ëŸ¬ ì²˜ë¦¬

## 7.1 ì—ëŸ¬ ë©”ì‹œì§€ í‘œ

| ì—ëŸ¬ ì½”ë“œ | ì‚¬ìš©ì ë©”ì‹œì§€ | ìë™ ì²˜ë¦¬ |
|-----------|-------------|-----------|
| `TOKEN_NOT_FOUND` | "Slack ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤. ì„¤ì • > Slackì—ì„œ ì—°ë™í•´ì£¼ì„¸ìš”." | - |
| `TOKEN_INVALID` | "Slack ì—°ë™ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ ë‹¤ì‹œ ì—°ë™í•´ì£¼ì„¸ìš”." | í† í° ìë™ ì‚­ì œ + `queryClient.invalidateQueries({ queryKey: ['slack-token-status'] })` ìºì‹œ ë¬´íš¨í™”. SlackSendModalì—ì„œ ìˆ˜ì‹  ì‹œ: alert("Slack ì—°ë™ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ì„¤ì • > Slack íƒ­ì—ì„œ ë‹¤ì‹œ ì—°ë™í•´ì£¼ì„¸ìš”.") â†’ ëª¨ë‹¬ ë‹«ê¸°. ì„¤ì • íƒ­ ìë™ ì „í™˜ì€ í•˜ì§€ ì•ŠìŒ (ì‚¬ìš©ìê°€ ìˆ˜ë™ ì§„ì…). |
| `RATE_LIMITED` | "{N}ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”." | ì¦‰ì‹œ ì—ëŸ¬ í‘œì‹œ (ìë™ ì¬ì‹œë„ ì—†ìŒ) |
| `NOT_IN_CHANNEL` | "í•´ë‹¹ ì±„ë„ì— ì°¸ì—¬í•˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. Slackì—ì„œ ì±„ë„ì— ë¨¼ì € ì°¸ì—¬í•´ì£¼ì„¸ìš”." | - |
| `CHANNEL_NOT_FOUND` | "ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì±„ë„ì„ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”." | ì±„ë„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (`queryClient.invalidateQueries({ queryKey: ['slack-channels'] })`) |
| `INTERNAL_ERROR` | "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”." | - |

## 7.2 ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ë©”ì‹œì§€

| ìƒí™© | ë©”ì‹œì§€ |
|------|--------|
| ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì‹¤íŒ¨ | "ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”." |
| Edge Function íƒ€ì„ì•„ì›ƒ | "ì„œë²„ê°€ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”." |
| ì„œë²„ ì˜¤ë¥˜ (5xx) | "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”." |

## 7.3 ì‚¬ìš©ì ì•Œë¦¼ íŒ¨í„´

ê¸°ì¡´ ì½”ë“œë² ì´ìŠ¤(JIRA íƒ­, ì´ë©”ì¼ íƒ­)ì™€ ë™ì¼í•˜ê²Œ `alert()`ì„ ì‚¬ìš©í•©ë‹ˆë‹¤:

```typescript
// ì„±ê³µ
alert(`#${channelName}ì— ë°œì‹ ë˜ì—ˆìŠµë‹ˆë‹¤`);

// ì‹¤íŒ¨ (ì—ëŸ¬ ì½”ë“œë³„ ë¶„ê¸° â€” ì„œë²„ì—ì„œ ë°˜í™˜í•œ í•œêµ­ì–´ ë©”ì‹œì§€ ì§ì ‘ ì‚¬ìš©)
if (result.errorCode === 'RATE_LIMITED' && result.retryAfter) {
  alert(`ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ${result.retryAfter}ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
} else {
  alert(result.error);
}

// ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬
alert('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');

// í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸
if (confirm('ì—°ë™ í•´ì œ ì‹œ ë©”ì‹œì§€ ë°œì‹ ì´ ë¶ˆê°€í•©ë‹ˆë‹¤. í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
  await deleteSlackToken(userId);
}
```

---

# 8. ë°°í¬ ê°€ì´ë“œ

## 8.1 í™˜ê²½ë³€ìˆ˜

### Edge Function Secrets (Supabase)

| ë³€ìˆ˜ëª… | ìš©ë„ | ì„¤ì • ìœ„ì¹˜ |
|--------|------|-----------|
| `SLACK_CLIENT_ID` | Slack App Client ID | Supabase Edge Function Secrets |
| `SLACK_CLIENT_SECRET` | Slack App Client Secret | Supabase Edge Function Secrets |
| `SLACK_REDIRECT_URI` | OAuth ì½œë°± URL | Supabase Edge Function Secrets |
| `APP_ORIGIN` | í”„ë¡ íŠ¸ì—”ë“œ Origin (postMessage targetOrigin) | Supabase Edge Function Secrets |

```bash
supabase secrets set SLACK_CLIENT_ID=your_client_id
supabase secrets set SLACK_CLIENT_SECRET=your_client_secret
supabase secrets set SLACK_REDIRECT_URI=https://vgoqkyqqkieogrtnmsva.supabase.co/functions/v1/slack-oauth-callback
supabase secrets set APP_ORIGIN=https://azrael-002.vercel.app
```

### í”„ë¡ íŠ¸ì—”ë“œ í™˜ê²½ë³€ìˆ˜ (Vercel)

| ë³€ìˆ˜ëª… | ìš©ë„ | ì„¤ì • ìœ„ì¹˜ |
|--------|------|-----------|
| `VITE_SLACK_CLIENT_ID` | Slack App Client ID (OAuth URL êµ¬ì„±ìš©) | Vercel í™˜ê²½ë³€ìˆ˜ |
| `VITE_SLACK_REDIRECT_URI` | OAuth ì½œë°± URL (OAuth URL êµ¬ì„±ìš©) | Vercel í™˜ê²½ë³€ìˆ˜ |

> **SLACK_CLIENT_ID**: Client IDëŠ” ê³µê°œ ì •ë³´ì´ë¯€ë¡œ í”„ë¡ íŠ¸ì—”ë“œ ë…¸ì¶œì— ë³´ì•ˆ ë¬¸ì œ ì—†ìŒ (Client Secretë§Œ ë¹„ê³µê°œ).
> **SLACK_REDIRECT_URI**: Supabase í”„ë¡œì íŠ¸ URL + `/functions/v1/slack-oauth-callback`. Slack App ì„¤ì •ì˜ Redirect URLê³¼ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.

## 8.2 Slack App ì„¤ì •

**í”„ë¡œë•ì…˜ ì•±**ê³¼ **ê°œë°œìš© ì•±**ì„ ê°ê° ìƒì„±í•©ë‹ˆë‹¤ (OAuth Redirect URIê°€ ë‹¤ë¥´ë¯€ë¡œ).

### í”„ë¡œë•ì…˜ Slack App
1. [Slack API](https://api.slack.com/apps)ì—ì„œ ìƒˆ ì•± ìƒì„± (From scratch, ì´ë¦„: "Azrael")
2. **OAuth & Permissions** ë©”ë‰´ì—ì„œ:
   - **Redirect URLs** ì¶”ê°€: `https://vgoqkyqqkieogrtnmsva.supabase.co/functions/v1/slack-oauth-callback`
   - **User Token Scopes** ì¶”ê°€:
     - `chat:write` â€” ë©”ì‹œì§€ ë°œì‹ 
     - `channels:read` â€” ê³µê°œ ì±„ë„ ëª©ë¡ ì¡°íšŒ
     - `groups:read` â€” ë¹„ê³µê°œ ì±„ë„ ëª©ë¡ ì¡°íšŒ
   - **Bot Token Scopes**: ì¶”ê°€ ë¶ˆí•„ìš” (User Tokenë§Œ ì‚¬ìš©)
3. **Basic Information**ì—ì„œ Client ID, Client Secret ë³µì‚¬ â†’ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
4. **Manage Distribution**: Workspaceì— ì•± ì„¤ì¹˜

### ê°œë°œìš© Slack App
1. ë³„ë„ ì•± ìƒì„± (ì´ë¦„: "Azrael Dev")
2. Redirect URL: `http://localhost:54321/functions/v1/slack-oauth-callback` (ë¡œì»¬ Supabase)
3. ë™ì¼í•œ User Token Scopes ì„¤ì •
4. Client ID/Secret â†’ `.env.local`ì— ì„¤ì •
5. ë¡œì»¬ Supabase Edge Function í™˜ê²½ë³€ìˆ˜ ì„¤ì •:
   ```bash
   supabase secrets set APP_ORIGIN=http://localhost:3000
   ```

> **Token Rotation**: Settings > OAuth & Permissionsì—ì„œ "Token Rotation" ë¹„í™œì„±í™” ìƒíƒœ í™•ì¸.
> í™œì„±í™” ì‹œ í† í° ê°±ì‹  ë¡œì§ì´ í•„ìš”í•˜ë¯€ë¡œ, ë¹„í™œì„±í™” ìƒíƒœë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.

> **postMessage targetOrigin**: `renderSuccessHtml()`ì—ì„œ `Deno.env.get('APP_ORIGIN')`ì„ ì‚¬ìš©í•˜ì—¬ ë™ì ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤. í”„ë¡œë•ì…˜: `https://azrael-002.vercel.app`, ê°œë°œ: `http://localhost:3000`.

## 8.3 Edge Function ë°°í¬

```bash
supabase functions deploy slack-send --no-verify-jwt
supabase functions deploy slack-channels --no-verify-jwt
supabase functions deploy slack-oauth-callback --no-verify-jwt
```

---

# 9. DB ë§ˆì´ê·¸ë ˆì´ì…˜

## 009_phase3_slack.sql

> **í•œê¸€ ì£¼ì„ ì»¨ë²¤ì…˜**: ê¸°ì¡´ ë§ˆì´ê·¸ë ˆì´ì…˜(001~008)ê³¼ ë™ì¼í•˜ê²Œ í•œê¸€ ì£¼ì„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. SQL ì£¼ì„(`--`), `COMMENT ON`, ì—ëŸ¬ ë©”ì‹œì§€ ëª¨ë‘ í•œê¸€ ê¸°ì¤€.

```sql
-- ============================================================
-- Migration 009: Phase 3 - Slack ì—°ë™
-- í…Œì´ë¸”: slack_user_tokens, slack_message_templates
-- ì»¬ëŸ¼ ì¶”ê°€: projects.slack_channel_id, projects.slack_channel_name
-- ì¶”ê°€ ì •ë¦¬: email_templates RLS â†’ auth.jwt() + 6ëª… íŒ¨í„´ í†µì¼
-- ============================================================

-- ============================================================
-- 1. slack_user_tokens (ì‚¬ìš©ìë³„ Slack OAuth í† í°)
-- ============================================================
-- user_idëŠ” TEXT íƒ€ì… (ê¸°ì¡´ jira_epic_mappings.created_by ë“±ê³¼ ë™ì¼í•œ convention)
CREATE TABLE slack_user_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT NOT NULL UNIQUE,
  access_token TEXT NOT NULL,
  slack_user_id TEXT NOT NULL,
  team_id TEXT NOT NULL,
  team_name TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

COMMENT ON TABLE slack_user_tokens IS 'ì‚¬ìš©ìë³„ Slack OAuth User Token ì €ì¥';
COMMENT ON COLUMN slack_user_tokens.user_id IS 'Supabase auth.uid() (TEXT)';
COMMENT ON COLUMN slack_user_tokens.access_token IS 'Slack User OAuth Token (xoxp-...)';
COMMENT ON COLUMN slack_user_tokens.slack_user_id IS 'Slack ë‚´ë¶€ User ID (U0123...)';
COMMENT ON COLUMN slack_user_tokens.team_id IS 'Slack Workspace ID (T0123...)';

-- updated_at ìë™ ê°±ì‹  íŠ¸ë¦¬ê±°
CREATE TRIGGER update_slack_user_tokens_updated_at
  BEFORE UPDATE ON slack_user_tokens
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

ALTER TABLE slack_user_tokens ENABLE ROW LEVEL SECURITY;

-- SELECT: ë³¸ì¸ í† í°ë§Œ ì¡°íšŒ (ëª¨ë“  ì¸ì¦ ì‚¬ìš©ì)
CREATE POLICY "Users can read own slack_user_tokens"
  ON slack_user_tokens FOR SELECT
  TO authenticated
  USING (auth.uid()::text = user_id);

-- INSERT: í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì‚¬ìš©ìë§Œ + ë³¸ì¸ ë ˆì½”ë“œë§Œ
CREATE POLICY "Whitelisted users can insert slack_user_tokens"
  ON slack_user_tokens FOR INSERT
  TO authenticated
  WITH CHECK (
    auth.jwt() ->> 'email' IN (
      'jkcho@wemade.com', 'mine@wemade.com', 'srpark@wemade.com',
      'garden0130@wemade.com', 'hkkim@wemade.com', 'uzilay@gmail.com'
    )
    AND auth.uid()::text = user_id
  );

-- UPDATE: í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì‚¬ìš©ìë§Œ + ë³¸ì¸ ë ˆì½”ë“œë§Œ
CREATE POLICY "Whitelisted users can update slack_user_tokens"
  ON slack_user_tokens FOR UPDATE
  TO authenticated
  USING (
    auth.jwt() ->> 'email' IN (
      'jkcho@wemade.com', 'mine@wemade.com', 'srpark@wemade.com',
      'garden0130@wemade.com', 'hkkim@wemade.com', 'uzilay@gmail.com'
    )
    AND auth.uid()::text = user_id
  );

-- DELETE: í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì‚¬ìš©ìë§Œ + ë³¸ì¸ ë ˆì½”ë“œë§Œ
CREATE POLICY "Whitelisted users can delete slack_user_tokens"
  ON slack_user_tokens FOR DELETE
  TO authenticated
  USING (
    auth.jwt() ->> 'email' IN (
      'jkcho@wemade.com', 'mine@wemade.com', 'srpark@wemade.com',
      'garden0130@wemade.com', 'hkkim@wemade.com', 'uzilay@gmail.com'
    )
    AND auth.uid()::text = user_id
  );

-- ============================================================
-- 2. projects í…Œì´ë¸”ì— Slack ì±„ë„ ë§¤í•‘ ì»¬ëŸ¼ ì¶”ê°€
-- ============================================================
ALTER TABLE projects
  ADD COLUMN IF NOT EXISTS slack_channel_id TEXT,
  ADD COLUMN IF NOT EXISTS slack_channel_name TEXT;

-- ì±„ë„ ë§¤í•‘ ë°ì´í„° ë¬´ê²°ì„±: channel_idì™€ channel_nameì€ í•¨ê»˜ NULLì´ê±°ë‚˜ í•¨ê»˜ NOT NULL
ALTER TABLE projects
  ADD CONSTRAINT chk_slack_channel_consistency
  CHECK (
    (slack_channel_id IS NULL AND slack_channel_name IS NULL) OR
    (slack_channel_id IS NOT NULL AND slack_channel_name IS NOT NULL)
  );

-- ============================================================
-- 3. slack_message_templates (ìŠ¬ë™ ë©”ì‹œì§€ í…œí”Œë¦¿)
-- ============================================================
CREATE TABLE slack_message_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id TEXT NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  name TEXT NOT NULL CHECK (char_length(name) <= 50),
  body_template TEXT NOT NULL,
  is_built_in BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by TEXT,
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(project_id, name)
);

COMMENT ON TABLE slack_message_templates IS 'í”„ë¡œì íŠ¸ë³„ ìŠ¬ë™ ë©”ì‹œì§€ í…œí”Œë¦¿';
COMMENT ON COLUMN slack_message_templates.is_built_in IS 'ê¸°ë³¸ ì œê³µ í…œí”Œë¦¿ ì—¬ë¶€ (true=ì‚­ì œ ë¶ˆê°€, seed trigger ì „ìš©)';
COMMENT ON COLUMN slack_message_templates.created_by IS 'ìƒì„±ì ì´ë©”ì¼ ë˜ëŠ” SYSTEM';

-- ì¸ë±ìŠ¤ (email_templates íŒ¨í„´ ë™ì¼)
CREATE INDEX idx_slack_message_templates_project_id
  ON slack_message_templates(project_id);
CREATE INDEX idx_slack_message_templates_is_built_in
  ON slack_message_templates(is_built_in);
CREATE INDEX idx_slack_message_templates_created_by
  ON slack_message_templates(created_by);

-- updated_at ìë™ ê°±ì‹  íŠ¸ë¦¬ê±°
CREATE TRIGGER update_slack_message_templates_updated_at
  BEFORE UPDATE ON slack_message_templates
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

ALTER TABLE slack_message_templates ENABLE ROW LEVEL SECURITY;

-- SELECT: ëª¨ë“  ì¸ì¦ ì‚¬ìš©ì ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Authenticated users can read slack_message_templates"
  ON slack_message_templates FOR SELECT
  TO authenticated
  USING (true);

-- INSERT
CREATE POLICY "Whitelisted users can insert slack_message_templates"
  ON slack_message_templates FOR INSERT
  TO authenticated
  WITH CHECK (
    auth.jwt() ->> 'email' IN (
      'jkcho@wemade.com', 'mine@wemade.com', 'srpark@wemade.com',
      'garden0130@wemade.com', 'hkkim@wemade.com', 'uzilay@gmail.com'
    )
    AND is_built_in = false  -- í”„ë¡ íŠ¸ì—”ë“œì—ì„œ built-in í…œí”Œë¦¿ ì§ì ‘ ìƒì„± ê¸ˆì§€ (seed trigger ì „ìš©)
  );

-- UPDATE
CREATE POLICY "Whitelisted users can update slack_message_templates"
  ON slack_message_templates FOR UPDATE
  TO authenticated
  USING (
    auth.jwt() ->> 'email' IN (
      'jkcho@wemade.com', 'mine@wemade.com', 'srpark@wemade.com',
      'garden0130@wemade.com', 'hkkim@wemade.com', 'uzilay@gmail.com'
    )
  );

-- DELETE: built-in ì•„ë‹Œ ê²ƒë§Œ
CREATE POLICY "Whitelisted users can delete custom slack_message_templates"
  ON slack_message_templates FOR DELETE
  TO authenticated
  USING (
    auth.jwt() ->> 'email' IN (
      'jkcho@wemade.com', 'mine@wemade.com', 'srpark@wemade.com',
      'garden0130@wemade.com', 'hkkim@wemade.com', 'uzilay@gmail.com'
    )
    AND is_built_in = false
  );

-- ============================================================
-- 4. ê¸°ë³¸ ìŠ¬ë™ ë©”ì‹œì§€ í…œí”Œë¦¿ ì‹œë“œ íŠ¸ë¦¬ê±° (ìƒˆ í”„ë¡œì íŠ¸ìš©)
-- ============================================================
CREATE OR REPLACE FUNCTION seed_slack_message_templates_for_project()
RETURNS TRIGGER
SECURITY DEFINER
AS $$
BEGIN
  INSERT INTO slack_message_templates (project_id, name, body_template, is_built_in, created_by)
  VALUES (
    NEW.id,
    'ê¸°ë³¸ í…œí”Œë¦¿',
    '*[{updateDateShort} ì—…ë°ì´íŠ¸ ì¼ì •]*

*í—¤ì¦ˆì—…:* {headsUp}
{{#if showIosReviewDate}}*iOS ì‹¬ì‚¬ì¼:* {iosReviewDate}
{{/if}}{{#if showPaidProductDate}}*ìœ ë£Œí™” ìƒí’ˆ í˜‘ì˜:* {paidProductDate}
{{/if}}
---

{table}

{{#if disclaimer}}---
_{disclaimer}_
{{/if}}
<https://azrael-002.vercel.app|Azraelì—ì„œ ìì„¸íˆ ë³´ê¸°>',
    true,
    'SYSTEM'
  );
  RETURN NEW;
EXCEPTION WHEN OTHERS THEN
  RAISE EXCEPTION 'ìŠ¬ë™ ê¸°ë³¸ í…œí”Œë¦¿ ì‹œë“œ ì‹¤íŒ¨ (project_id=%): %', NEW.id, SQLERRM
    USING ERRCODE = 'P0001';
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_seed_slack_message_templates
  AFTER INSERT ON projects
  FOR EACH ROW
  EXECUTE FUNCTION seed_slack_message_templates_for_project();

-- ============================================================
-- 5. ê¸°ì¡´ í”„ë¡œì íŠ¸ìš© ê¸°ë³¸ ìŠ¬ë™ í…œí”Œë¦¿ ì‹œë“œ
-- ì˜ë„ì  ê²°ì •: ìŠ¬ë™ í…œí”Œë¦¿ì€ "ê¸°ë³¸ í…œí”Œë¦¿" 1ì¢…ë§Œ ì‹œë“œ (ì´ë©”ì¼ì€ 2ì¢…).
-- ìŠ¬ë™ ë©”ì‹œì§€ íŠ¹ì„±ìƒ ê°„ê²°í•œ 1ì¢…ì´ë©´ ì¶©ë¶„í•˜ë©°, ì‚¬ìš©ìê°€ ì¶”ê°€ ìƒì„± ê°€ëŠ¥.
-- ============================================================
INSERT INTO slack_message_templates (project_id, name, body_template, is_built_in, created_by)
SELECT
  p.id,
  'ê¸°ë³¸ í…œí”Œë¦¿',
  '*[{updateDateShort} ì—…ë°ì´íŠ¸ ì¼ì •]*

*í—¤ì¦ˆì—…:* {headsUp}
{{#if showIosReviewDate}}*iOS ì‹¬ì‚¬ì¼:* {iosReviewDate}
{{/if}}{{#if showPaidProductDate}}*ìœ ë£Œí™” ìƒí’ˆ í˜‘ì˜:* {paidProductDate}
{{/if}}
---

{table}

{{#if disclaimer}}---
_{disclaimer}_
{{/if}}
<https://azrael-002.vercel.app|Azraelì—ì„œ ìì„¸íˆ ë³´ê¸°>',
  true,
  'SYSTEM'
FROM projects p
WHERE NOT EXISTS (
  SELECT 1 FROM slack_message_templates smt
  WHERE smt.project_id = p.id AND smt.name = 'ê¸°ë³¸ í…œí”Œë¦¿'
);

-- ============================================================
-- 6. email_templates RLS ì •ì±… í†µì¼ (ë°©ì–´ì  ì¬ìƒì„±)
-- ì°¸ê³ : migration 008ì—ì„œ ì´ë¯¸ auth.jwt() + 6ëª… íŒ¨í„´ìœ¼ë¡œ ê°±ì‹ ë¨.
-- ì´ ì„¹ì…˜ì€ íŒ¨í„´ í†µì¼ì„ ìœ„í•œ ë°©ì–´ì  ì¬ìƒì„±ì´ë©°, DROP IF EXISTSë¡œ ì•ˆì „.
-- ë³€ê²½ ì˜ë¯¸: ê¸°ì¡´ auth.email() â†’ auth.jwt()->>email íŒ¨í„´ìœ¼ë¡œ í†µì¼í•˜ê³ ,
--   í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì¸ì›ì„ 5ëª…â†’6ëª…(uzilay@gmail.com ì¶”ê°€)ìœ¼ë¡œ ê°±ì‹ .
--   SELECT ì •ì±…ì˜ USING(true)ëŠ” ê¸°ì¡´ê³¼ ë™ì¼ (ëª¨ë“  ì¸ì¦ ì‚¬ìš©ìê°€ ì½ê¸° ê°€ëŠ¥).
-- ============================================================
-- ê¸°ì¡´ ì •ì±… ì‚­ì œ
DROP POLICY IF EXISTS "Authenticated users can read email_templates" ON email_templates;
DROP POLICY IF EXISTS "Whitelisted users can insert email_templates" ON email_templates;
DROP POLICY IF EXISTS "Whitelisted users can update email_templates" ON email_templates;
DROP POLICY IF EXISTS "Whitelisted users can delete custom email_templates" ON email_templates;

-- ìƒˆ ì •ì±… ìƒì„± (auth.jwt() íŒ¨í„´ + 6ëª…)
CREATE POLICY "Authenticated users can read email_templates"
  ON email_templates FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY "Whitelisted users can insert email_templates"
  ON email_templates FOR INSERT
  TO authenticated
  WITH CHECK (
    auth.jwt() ->> 'email' IN (
      'jkcho@wemade.com', 'mine@wemade.com', 'srpark@wemade.com',
      'garden0130@wemade.com', 'hkkim@wemade.com', 'uzilay@gmail.com'
    )
  );

CREATE POLICY "Whitelisted users can update email_templates"
  ON email_templates FOR UPDATE
  TO authenticated
  USING (
    auth.jwt() ->> 'email' IN (
      'jkcho@wemade.com', 'mine@wemade.com', 'srpark@wemade.com',
      'garden0130@wemade.com', 'hkkim@wemade.com', 'uzilay@gmail.com'
    )
  );

CREATE POLICY "Whitelisted users can delete custom email_templates"
  ON email_templates FOR DELETE
  TO authenticated
  USING (
    auth.jwt() ->> 'email' IN (
      'jkcho@wemade.com', 'mine@wemade.com', 'srpark@wemade.com',
      'garden0130@wemade.com', 'hkkim@wemade.com', 'uzilay@gmail.com'
    )
    AND is_built_in = false
  );
```

---

# 10. ì‚¬ìš©ì ìŠ¤í† ë¦¬

**ìŠ¤í† ë¦¬ 1**: ìŠ¬ë™ ë©”ì‹œì§€ ìë™ ë°œì‹ 
- **As a** L10n íŒ€ì›
- **I want to** ê³„ì‚°ëœ ì¼ì •ì„ ìŠ¬ë™ ì±„ë„ì— ìë™ìœ¼ë¡œ ê³µìœ í•˜ê³  ì‹¶ë‹¤
- **So that** íŒ€ì›ë“¤ì´ ìŠ¬ë™ì—ì„œ ë°”ë¡œ ì¼ì •ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤

**ìŠ¤í† ë¦¬ 2**: ì±„ë„ ì„ íƒ
- **As a** L10n íŒ€ì›
- **I want to** í”„ë¡œì íŠ¸ë³„ë¡œ ë‹¤ë¥¸ ìŠ¬ë™ ì±„ë„ì— ë°œì‹ í•˜ê³  ì‹¶ë‹¤
- **So that** ê´€ë ¨ íŒ€ì›ì—ê²Œë§Œ ì •ë³´ë¥¼ ê³µìœ í•  ìˆ˜ ìˆë‹¤

**ìŠ¤í† ë¦¬ 3**: ë©”ì‹œì§€ í…œí”Œë¦¿ ì»¤ìŠ¤í„°ë§ˆì´ì§•
- **As a** L10n íŒ€ì›
- **I want to** í”„ë¡œì íŠ¸ë³„ë¡œ ë‹¤ë¥¸ ìŠ¬ë™ ë©”ì‹œì§€ í˜•ì‹ì„ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤
- **So that** ìˆ˜ì‹  ëŒ€ìƒ(ë‚´ë¶€/ì™¸ë¶€)ì— ë§ëŠ” ì •ë³´ë§Œ í¬í•¨í•  ìˆ˜ ìˆë‹¤

**ìŠ¤í† ë¦¬ 4**: ìŠ¤ë ˆë“œ ë¦¬í”Œë¼ì´
- **As a** L10n íŒ€ì›
- **I want to** ê¸°ì¡´ ë©”ì‹œì§€ì— ë¦¬í”Œë¼ì´ë¡œ í›„ì† ì •ë³´ë¥¼ ë³´ë‚´ê³  ì‹¶ë‹¤
- **So that** ê´€ë ¨ ì¼ì • ë³€ê²½ì‚¬í•­ì´ í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œì— ì •ë¦¬ëœë‹¤

---

# 11. ì¸ìˆ˜ ê¸°ì¤€

| ê¸°ëŠ¥ | ì¸ìˆ˜ ê¸°ì¤€ |
|------|-----------|
| Slack OAuth ì—°ë™ | ì„¤ì • > Slackì—ì„œ ì—°ë™/í•´ì œ ê°€ëŠ¥, í† í° DB ì €ì¥ (user_id = Supabase UID), í•´ì œ ì‹œ ë ˆì½”ë“œ ì‚­ì œ |
| ì±„ë„ ëª©ë¡ ì¡°íšŒ | Slack API í˜¸ì¶œ ì„±ê³µ ì‹œ ê³µê°œ+ë¹„ê³µê°œ ì±„ë„ ì´ë¦„ìˆœ ì •ë ¬ í‘œì‹œ (ê³µê°œ ìµœëŒ€ 200ê°œ + ë¹„ê³µê°œ ìµœëŒ€ 200ê°œ, í•©ê³„ ìµœëŒ€ 400ê°œ) |
| í”„ë¡œì íŠ¸ë³„ ê¸°ë³¸ ì±„ë„ | ì„¤ì •ì—ì„œ ë§¤í•‘ (projects í…Œì´ë¸” ì €ì¥), ë°œì‹  ëª¨ë‹¬ì—ì„œ ìë™ ì„ íƒ |
| ë©”ì‹œì§€ ë°œì‹  | ì„ íƒí•œ ì±„ë„ì— mrkdwn ë©”ì‹œì§€ ë°œì‹  ì„±ê³µ, ì„±ê³µ/ì‹¤íŒ¨ alert |
| ìŠ¤ë ˆë“œ ë¦¬í”Œë¼ì´ | thread_ts ì…ë ¥ ì‹œ ë¦¬í”Œë¼ì´ë¡œ ë°œì‹  |
| ë©”ì‹œì§€ í…œí”Œë¦¿ | CRUD ë™ì‘, ê¸°ë³¸ ì œê³µ í…œí”Œë¦¿ ì‚­ì œ ë¶ˆê°€, ë³€ìˆ˜ ì¹˜í™˜ ì •ìƒ ë™ì‘ |
| ì—ëŸ¬ ì²˜ë¦¬ | í† í° ë§Œë£Œ ì‹œ ìë™ ì‚­ì œ, Rate limit ì¦‰ì‹œ ì—ëŸ¬ í‘œì‹œ (ì¬ì‹œë„ ëŒ€ê¸° ì‹œê°„ ì•ˆë‚´) |
| ë¯¸ë¦¬ë³´ê¸° | ê°„ì´ mrkdwn ë Œë”ë§ìœ¼ë¡œ ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ (XSS ë°©ì§€) |

---

# 12. ì„±ê³µ ì§€í‘œ

| ê¸°ëŠ¥ | ì§€í‘œ | ëª©í‘œ |
|------|------|------|
| ìŠ¬ë™ ë°œì‹  | ë©”ì‹œì§€ ì‘ì„± ì‹œê°„ ë‹¨ì¶• | 95% (5ë¶„ â†’ 15ì´ˆ) |

---

# 13. êµ¬í˜„ ìˆœì„œ (ê¶Œì¥)

1. **DB ë§ˆì´ê·¸ë ˆì´ì…˜** (009_phase3_slack.sql) â€” ê¸°ì¡´ ë§ˆì´ê·¸ë ˆì´ì…˜: 001~008 (006b í¬í•¨)
2. **Edge Functions** (slack-oauth-callback â†’ slack-channels â†’ slack-send)
3. **í”„ë¡ íŠ¸ì—”ë“œ íƒ€ì… + ë§¤í•‘ í•¨ìˆ˜ ì—…ë°ì´íŠ¸**:
   - `src/types/index.ts`ì— ì¶”ê°€: SlackSendModalProps, SlackSendRequest, SlackSendResponse, SlackChannel, SlackMessageTemplate + Project í™•ì¥ (slackChannelId, slackChannelName)
   - `src/types/supabase.ts` ì—…ë°ì´íŠ¸: projects Row/Insert/Updateì— `slack_channel_id`, `slack_channel_name` ì¶”ê°€ + slack_user_tokens, slack_message_templates í…Œì´ë¸” íƒ€ì… ì¶”ê°€
   - `src/lib/api/projects.ts`ì˜ `mapToProject()` í•¨ìˆ˜ì— `slackChannelId`, `slackChannelName` ë§¤í•‘ ì¶”ê°€ (snake_case â†’ camelCase)
4. **API ë ˆì´ì–´** (`src/lib/api/slack.ts` â€” fetch íŒ¨í„´)
5. **Slack í¬ë§·í„°** (`src/lib/slack/formatter.ts`, `slackGenerator.ts`) â€” `getEntriesByTableType`ëŠ” ê¸°ì¡´ email generatorì—ì„œ import
6. **React Query í›…** (`src/hooks/useSlackTemplates.ts`)
7. **Settings > Slack íƒ­** (SettingsSlackTab.tsx â€” OAuth + ì±„ë„ë§¤í•‘ + í…œí”Œë¦¿)
8. **ë°œì‹  ëª¨ë‹¬** (SlackSendModal.tsx)
9. **MainScreen í†µí•©** (ë²„íŠ¼ + `currentUserId` state ì¶”ê°€ + í† í° ìƒíƒœ ì¡°íšŒ + SettingsScreen íƒ­ í™•ì¥)

---

# 14. ì°¸ì¡° ë¬¸ì„œ

- **Master**: [Azrael-PRD-Master.md](./Azrael-PRD-Master.md) Â§3.4 (Phase 3 ê°œìš”)
- **Shared**: [Azrael-PRD-Shared.md](./Azrael-PRD-Shared.md) (ê³µí†µ ë°ì´í„° êµ¬ì¡°, ë³€ìˆ˜ ì¹˜í™˜)
- **Phase 2 (ì´ë©”ì¼)**: [Azrael-PRD-Phase2.md](./Azrael-PRD-Phase2.md) (í…œí”Œë¦¿ íŒ¨í„´ ì°¸ì¡°)
- **Phase 4 (í”„ë¦¬ì…‹)**: [Azrael-PRD-Phase4.md](./Azrael-PRD-Phase4.md)
- **Design**: [Azrael-PRD-Design.md](./Azrael-PRD-Design.md)

> **ì°¸ê³ **: Shared PRD ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•œ í•­ëª© ì²´í¬ë¦¬ìŠ¤íŠ¸ (Phase 3 êµ¬í˜„ ì‹œì‘ ì „ì— ë°˜ì˜):
> - [ ] Â§2.1 Project ì¸í„°í˜ì´ìŠ¤ì— `slackChannelId?`, `slackChannelName?` í•„ë“œ ì¶”ê°€
> - [ ] Â§3.3 í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ë¥¼ 6ëª… + `auth.jwt()` íŒ¨í„´ìœ¼ë¡œ ê°±ì‹  (í˜„ì¬ 5ëª… + `auth.email()`)
> - [ ] Â§5 í…Œì´ë¸” ëª©ë¡ì— `slack_user_tokens`, `slack_message_templates` ì¶”ê°€
> - [ ] Â§6 RLS íŒ¨í„´ ì„¤ëª…ì— `auth.jwt() ->> 'email'` íŒ¨í„´ ë°˜ì˜
>
> **ì™„ë£Œ ì‹œì **: Phase 3 êµ¬í˜„ ì°©ìˆ˜ ì‹œ ì²« ë²ˆì§¸ ì‘ì—…ìœ¼ë¡œ Shared PRDë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤. Phase 3 PRD ë‚´ íƒ€ì…/í…Œì´ë¸” ëª…ì„¸ê°€ ì •ë³¸ì´ë©°, Shared PRDì—ëŠ” ìš”ì•½ë§Œ ë°˜ì˜í•©ë‹ˆë‹¤.

---

# ë³€ê²½ ì´ë ¥

| ë²„ì „ | ë‚ ì§œ | ë³€ê²½ ë‚´ìš© |
|------|------|-----------|
| 2.0 | 2026-01-26 | ì´ˆê¸° ì‘ì„± (Phase ë¶„í• ) |
| 3.0 | 2026-02-08 | 1ì°¨ íŒ€ ë¦¬ë·° ë°˜ì˜: OAuth scope ìˆ˜ì •(user_scope), ì½œë°± êµ¬í˜„ ì™„ì„±, state í´ë¼ì´ì–¸íŠ¸ ê²€ì¦, ë§ˆì´ê·¸ë ˆì´ì…˜ 009, RLS íŒ¨í„´ í†µì¼(auth.jwt()/6ëª…), Edge Function íŒ¨í„´ í†µì¼(serve), ë©”ì‹œì§€ í…œí”Œë¦¿ ê¸°ëŠ¥ ì¶”ê°€, ìŠ¤ë ˆë“œ ë¦¬í”Œë¼ì´ ì¶”ê°€, í•˜ì´ë¸Œë¦¬ë“œ íŒŒì„œ ì•„í‚¤í…ì²˜, mrkdwn ë¯¸ë¦¬ë³´ê¸°, not_in_channel ì—ëŸ¬ ì²˜ë¦¬, Settings Slack íƒ­ ëª…ì„¸, ì¸ìˆ˜ ê¸°ì¤€ ì¶”ê°€ |
| 3.1 | 2026-02-08 | 2ì°¨ íŒ€ ë¦¬ë·° ë°˜ì˜: (C1) user_id ë§¤í•‘ â€” stateì— `{csrf}:{supabaseUid}` ì¸ì½”ë”©ì„ ì‹¤ì œ ì½”ë“œì— ë°˜ì˜, (C2) XSS â€” data-* ì†ì„± + entity escapeë¡œ ìˆ˜ì •, (C3) toastâ†’alert íŒ¨í„´ í†µì¼, (M1) fetch() íŒ¨í„´ í†µì¼, (M2) DB íŠ¸ë¦¬ê±°ë¡œ ê¸°ë³¸ í…œí”Œë¦¿ ìë™ ìƒì„±, (M3) updated_at íŠ¸ë¦¬ê±° ì¶”ê°€, (M4) slack_channels í…Œì´ë¸” ì œê±°â†’projects ì»¬ëŸ¼ ì¶”ê°€, (M5) formatUpdateDateShort MM-DDë¡œ ì˜ˆì‹œ ìˆ˜ì •, (M6) í† í° ìƒíƒœ API/í›… ì¶”ê°€, (M7) ì±„ë„ ë§¤í•‘ API ëª…ì‹œ, (M8) mrkdwn ë¯¸ë¦¬ë³´ê¸° XSS ë°©ì§€, (Q2) email_templates RLS ì •ë¦¬ í¬í•¨, channel_not_found ë¶„ê¸° ì¶”ê°€, private channel graceful degradation, CHECK/ì¸ë±ìŠ¤ ì¶”ê°€ |
| 3.2 | 2026-02-08 | 3ì°¨ íŒ€ ë¦¬ë·° ë°˜ì˜: [M1] í”„ë¡ íŠ¸ì—”ë“œ í™˜ê²½ë³€ìˆ˜(VITE_SLACK_CLIENT_ID, VITE_SLACK_REDIRECT_URI) ëª…ì‹œ + Vercel í™˜ê²½ë³€ìˆ˜ í…Œì´ë¸” ì¶”ê°€, [M2] currentUserId state ì „ë‹¬ ê²½ë¡œ ëª…ì‹œ(MainScreenâ†’SettingsScreenâ†’SlackSendModal), [M3] SlackSendModalProps ì¸í„°í˜ì´ìŠ¤ ì •ì˜ + types/index.ts ë°°ì¹˜ ëª…ì‹œ, [M4] lazy import ê²½ë¡œ ìˆ˜ì •(.then(mâ‡’) íŒ¨í„´ í†µì¼), [M5] supabase.ts íƒ€ì… ì—…ë°ì´íŠ¸ êµ¬í˜„ ìˆœì„œì— ëª…ì‹œ, [M6] seed íŠ¸ë¦¬ê±° SECURITY DEFINER + EXCEPTION ë¸”ë¡ ì¶”ê°€, [M7] email_templates RLS ë°©ì–´ì  ì¬ìƒì„± ì£¼ì„, [M8] ì±„ë„ ì¡°íšŒ 200â†’ê³µê°œ200+ë¹„ê³µê°œ200(í•©ê³„400) ìˆ˜ì •, ê°œë°œìš© Slack App ê°€ì´ë“œ ì¶”ê°€, ì‹œë“œ í…œí”Œë¦¿ 1ì¢… ì˜ë„ì  ê²°ì • ëª…ì‹œ, getEntriesByTableType ì´ë©”ì¼/ìŠ¬ë™ ê³µìš© ëª…ì‹œ |
| 3.3 | 2026-02-09 | 4ì°¨ íŒ€ ë¦¬ë·° ë°˜ì˜: [M1] substituteDisclaimerVariables ì‹œê·¸ë‹ˆì²˜ë¥¼ ì‹¤ì œ í•¨ìˆ˜ì— ë§ê²Œ ìˆ˜ì •, [M2] currentUserIdë¥¼ MainScreen Propsë¡œ ì „ë‹¬, [M3] APP_ORIGIN í™˜ê²½ë³€ìˆ˜ ì ìš©(postMessage targetOrigin ë™ì  ì„¤ì •), [M4] slack_user_tokens INSERT/UPDATE/DELETE RLSì— ë³¸ì¸ ì œí•œ(auth.uid()::text = user_id) ì¶”ê°€, [M5] Â§11 ì¸ìˆ˜ ê¸°ì¤€ ì±„ë„ ìˆ˜ í•©ê³„ 400ê°œë¡œ í†µì¼, [M6] CHANNEL_NOT_FOUND ì—ëŸ¬ ì‹œ queryClient.invalidateQueries ëª…ì‹œ, [M7] Â§14 Shared PRD ì—…ë°ì´íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì¶”ê°€, [M8] chat.postMessage mrkdwn íŒŒë¼ë¯¸í„° ì œê±°, [M9] email_templates RLS ë³€ê²½ ì˜ë¯¸ ì£¼ì„, [M10] projects.ts mapToProject() ë§¤í•‘ êµ¬í˜„ ìˆœì„œì— ì¶”ê°€, [Q2] built-in í…œí”Œë¦¿ ì§ì ‘ í¸ì§‘ ì •ì±… ëª…ì‹œ, [Q4] Rate Limit ì¦‰ì‹œ ì—ëŸ¬ í‘œì‹œ(ìë™ ì¬ì‹œë„ ì œê±°), regex [\s\S]*? ë©€í‹°ë¼ì¸ ëŒ€ì‘, formatTableMrkdwn ë‚ ì§œ í˜•ì‹ í•¨ìˆ˜ ëª…ì‹œ, useSlackTokenStatus íŒŒì¼ ë°°ì¹˜ í™•ì •, renderMrkdwnPreview í•¨ìˆ˜ ë°°ì¹˜ ëª…ì‹œ |
| 3.4 | 2026-02-09 | 5ì°¨ íŒ€ ë¦¬ë·° ë°˜ì˜: [C1] postMessage origin ê²€ì¦ â€” window.location.originâ†’VITE_SUPABASE_URLë¡œ ìˆ˜ì •(Supabase ë„ë©”ì¸ í—ˆìš©), [M2] Â§6.2 DELETE RLSì— auth.uid() ë³¸ì¸ ì œí•œ ì¶”ê°€(Â§9 í†µì¼), [M3] substituteDisclaimerVariables í˜¸ì¶œì„ calcResult ì§ì ‘ ì „ë‹¬ë¡œ ê°„ì†Œí™”, [M4+m4] useSlackChannels ì¸ë¼ì¸ useQuery ëª…ì‹œ + useSlackTokenStatus ë³„ë„ íŒŒì¼ í™•ì •, [M5+Q2] thread_ts ìœ íš¨ì„± ê²€ì¦ â€” Slack API ì—ëŸ¬ ì˜ì¡´ìœ¼ë¡œ ëª…ì‹œ + parseThreadTs ë°°ì¹˜, [m1] renderTemplate decodeTemplateEntities ë¬´í•´ í†µê³¼ ì£¼ì„, [m2] built-in í…œí”Œë¦¿ ì´ë¦„ readonly ëª…ì‹œ, [m3] ì±„ë„ pagination ì˜ë„ì  ê²°ì • ì‚¬ìœ  + graceful degradation ëª…ì‹œ, [m5] formatTableMrkdwn entries í‰íƒ„í™”/parentId ì¸ë´íŠ¸ + *[ì¼ì • ìš”ì•½]* ìë™ í¬í•¨, [m7] ë°œì‹  ë²„íŠ¼ isSending ìƒíƒœ + disabled + "ë°œì‹  ì¤‘..." í…ìŠ¤íŠ¸, [m8] dangerouslySetInnerHTML ì•ˆì „ì„± ì£¼ì„, [m10] ì±„ë„ ë§¤í•‘ ì €ì¥ ì‹œ projects queryKey invalidate ëª…ì‹œ, [Q1] currentUserIdë¥¼ MainScreenì—ì„œ 1íšŒ ì¡°íšŒ í›„ í•˜ìœ„ ì „ë‹¬ í™•ì • |
| 3.6 | 2026-02-09 | 7ì°¨ íŒ€ ë¦¬ë·° ë°˜ì˜: [M] Â§3.2 OAuth íŒì—… cleanup ìƒëª…ì£¼ê¸° â€” popupCheckInterval+postMessage ë¦¬ìŠ¤ë„ˆë¥¼ named handlerë¡œ í†µí•©, useEffect cleanupì—ì„œ interval+removeEventListener ëª¨ë‘ ì •ë¦¬, [M] Â§2.4 ì¡°ê±´ë¶€ ë¸”ë¡ ì¤„ë°”ê¿ˆ ì²˜ë¦¬ ë™ì‘ ëª…ì‹œ(false ë¸”ë¡=ê°œí–‰ í¬í•¨ ì œê±°), [M] Â§6.5 createSlackTemplate isBuiltIn Omit ì˜ë„ ì£¼ì„(DB DEFAULT+RLS ì´ì¤‘ ë³´ì¥), [M] Â§6.4 invalidateQueries projectId ëª…ì‹œ, [M] Â§6.3 state íŒŒì‹± split(':', 2) ê°„ì†Œí™”, [M] Â§6.3 Promise.allSettled+warning í”Œë˜ê·¸, [M] Â§6.3 OAuth ì—ëŸ¬ ë©”ì‹œì§€ ì‚¬ìš©ì/ê°œë°œì ë¶„ë¦¬, [M] Â§6.1 SlackChannel JSDoc(ëŸ°íƒ€ì„ ì „ìš©), [M] Â§5.2 ìƒˆ í…œí”Œë¦¿ ì¶”ê°€ UI í”Œë¡œìš°/ì´ˆê¸°ê°’ ëª…ì‹œ, [M] Â§5.2 ì±„ë„ ë§¤í•‘ ì €ì¥ ì‹¤íŒ¨ ë¡¤ë°± ì •ì±…, [M] Â§5.2 ì—°ë™/í•´ì œ ì‹œ ìºì‹œ ë¬´íš¨í™”, [M] Â§4.2 ë°œì‹  ì‹¤íŒ¨ ìƒíƒœ ìœ ì§€+ë²„íŠ¼ ì¬í™œì„±í™”, [M] Â§4.3 ë‹¤ì‹œ ì‹œë„ ë²„íŠ¼ ë™ì‘ ëª…ì‹œ, [L] Â§4.3 ë¯¸ë¦¬ë³´ê¸° min-height:100px, [L] Â§7.1 TOKEN_INVALID ìƒì„¸ ë™ì‘, [L] Â§7.3 Rate Limit retryAfter UI ì½”ë“œ ì˜ˆì‹œ, [L] Â§6.5 getEntriesByTableType ë°˜í™˜ íƒ€ì… ëª…ì‹œ, [L] Â§6.5 ì¤‘ì²© íƒœê·¸ ì²˜ë¦¬ ìˆœì„œ JSDoc, [L] Â§9 INSERT RLS is_built_in=false ì¶”ê°€, [L] Â§9 CHECK constraint chk_slack_channel_consistency, [L] Â§9 í•œê¸€ ì£¼ì„ ì»¨ë²¤ì…˜ ëª…ì‹œ. ì‚¬ìš©ì ê²°ì •: user_id TEXT ìœ ì§€(ê¸°ì¡´ íŒ¨í„´ ì¼ê´€ì„±), getUser ì‹¤íŒ¨ ë³„ë„ ì²˜ë¦¬ ë¶ˆí•„ìš” |
| 3.5 | 2026-02-09 | 6ì°¨ íŒ€ ë¦¬ë·° ë°˜ì˜: **HIGH** â€” [H1] SettingsScreen auth ì´ì¤‘ ê²½ë¡œ í•´ì†Œ(currentUserId+currentUserEmail Props ì „ë‹¬, ë‚´ë¶€ getUser() ì œê±°), [H2] Â§6.5 import ê²½ë¡œ ëª…ì‹œ(formatEmailDate/formatUpdateDateShort/getEntriesByTableType/substituteDisclaimerVariables/renderTemplate), [H3] Â§6.1 supabase.ts íƒ€ì… ì •ì˜ ì¶”ê°€(slack_user_tokens, slack_message_templates + projects slack í•„ë“œ), [H4] Â§6.2 Service Role Key RLS bypass defense-in-depth ì£¼ì„, [H5] Â§7.1 TOKEN_INVALID ì‹œ SlackSendModalâ†’ëª¨ë‹¬ ë‹«ê¸°+ì„¤ì • ë¦¬ë‹¤ì´ë ‰íŠ¸+ìºì‹œ ë¬´íš¨í™”. **MEDIUM** â€” [M1] Â§6.3 !publicResult.ok ì—ëŸ¬ ì‘ë‹µ ì¶”ê°€, [M2] TOKEN_INVALID ì‹œ slack-token-status ìºì‹œ ë¬´íš¨í™”, [M3] queryKey ['slack-templates', projectId] ëª…ì‹œ, [M4] OAuth íŒì—… ìˆ˜ë™ ë‹«ê¸° ê°ì§€(setInterval popup.closed + cleanup), [M5] sendSlackMessage try/catch ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ë˜í•‘, [M6] ê¸°ë³¸ í…Œì´ë¸” T2 ëª…ì‹œ, [M7] ë¯¸ë¦¬ë³´ê¸° max-height 300px/overflow-y auto, [M8] createSlackTemplate Omitì— createdBy/isBuiltIn ì¶”ê°€, [M9] formatTableMrkdwn ë¹ˆ ë°°ì—´ ì²˜ë¦¬, [M10] NULL slackChannelId placeholder+ë°œì‹  disabled, [M11] ì±„ë„ useQuery staleTime 2ë¶„, [M12] ìŠ¤ë ˆë“œ ì²´í¬+ë¹ˆ ì…ë ¥=ë°œì‹  disabled, [M13] entry.index ì†Œìˆ˜ì  í¬í•¨ ì£¼ì„. **LOW** â€” ì±„ë„ ë§¤í•‘ ìë™ ì €ì¥, í…œí”Œë¦¿ í¸ì§‘ ëª¨ë‹¬, is_built_in NOT NULL, ì‹œë“œ íŠ¸ë¦¬ê±° í•œê¸€ ì—ëŸ¬+ERRCODE, ì¸ë±ìŠ¤ 2ê°œ ì¶”ê°€, COMMENT ON ë¬¸, seed WHERE name ê¸°ë°˜, ë Œë”ë§ ì˜ˆì‹œ ì°¸ì¡° ì£¼ì„, maxLength ëª…ì‹œ, showSlackModal state ëª…ì‹œ, ë²„íŠ¼ ğŸ’¬ ì´ëª¨ì§€, ARIA ì ‘ê·¼ì„±, ë²ˆí˜¸ ëª©ë¡ ë Œë”ë§ ì£¼ì„ |
| 3.7 | 2026-02-09 | 8ì°¨ íŒ€ ë¦¬ë·° ë°˜ì˜: [M] Â§ë³´ì•ˆ ì •ì±… CSRF í´ë¼ì´ì–¸íŠ¸ ì „ìš© ê²€ì¦ ì˜ë„ì  ê²°ì • ê·¼ê±° ë³´ê°•, [M] Â§4.1 useSlackTokenStatus enabled:!!userId ì•ˆì „ì„± ì£¼ì„, [M] Â§5.1 SettingsScreenProps ì¸í„°í˜ì´ìŠ¤ currentUserId/currentUserEmail ì¶”ê°€, [M] Â§5.2.2 ì±„ë„ ë§¤í•‘ optimistic update íŒ¨í„´ ì½”ë“œ ì˜ˆì‹œ ì¶”ê°€ + ë¹„ê³µê°œ ì±„ë„ ì¡°íšŒ ì‹¤íŒ¨ warning UI ëª…ì‹œ, [M] Â§6.4 mapToSlackMessageTemplate() ë§¤í•‘ í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ ì¶”ê°€ + saveChannelMapping ìœ ë‹ˆì˜¨ íƒ€ì… ìˆ˜ì •, [M] Â§6.5 TemplateContext íƒ€ì… import ê²½ë¡œ ëª…ì‹œ, [M] Â§14 Shared PRD ì—…ë°ì´íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì™„ë£Œ ì‹œì  ëª…ì‹œ |

---

**ë¬¸ì„œ ì¢…ë£Œ**
