# Azrael v1.2 개선사항 설계 문서

**작성일**: 2026-02-26
**상태**: 승인됨

---

## 개요

4개 기능 개선 + user-manual.html 최신화

---

## Feature #1: Epic Description에 표 자동 삽입

### 요구사항
- JIRA Epic 생성 시 Description에 T1/T2/T3 스케줄 테이블을 ADF 네이티브 테이블로 삽입
- 설정에서 ON/OFF 토글 + 테이블 선택 (라디오)
- JIRA 생성 및 업데이트 모두에서 반영

### UI 위치
ProjectEditModal: Epic Description 템플릿 textarea 바로 아래
```
Epic Description 템플릿 (선택)      ← Feature #3
┗ 표 자동 삽입 [토글 ON/OFF]
   삽입할 테이블: ○ T1  ○ T2  ○ T3   ← 토글 ON일 때만 노출
```

### 데이터
- DB: `jira_epic_table_enabled` (boolean, default false)
- DB: `jira_epic_table_type` (text: 'table1'|'table2'|'table3', default 'table1')
- Type: `Project.jiraEpicTableEnabled?: boolean`
- Type: `Project.jiraEpicTableType?: 'table1'|'table2'|'table3'`

### ADF 표 형식
T1: `||#|배치명|마감|테이블전달|설명|담당자||`
T2/T3: `||#|배치명|HO|HB|설명||` (JIRA 설명/담당자 컬럼 제외)

### 로직
1. `jiraEpicTableEnabled === true`이면 CalculationResult에서 해당 테이블 엔트리 추출
2. `formatScheduleTableForADF()` 신규 함수로 ADF 테이블 마크업 생성
3. Epic Description 템플릿 치환 결과 뒤에 표 문자열 이어 붙임
4. Edge Function에서 `textToADF()` 변환

### JIRA 업데이트 시
- `jira-update` Edge Function에 Epic description 업데이트 로직 추가
- 새 CalculationResult로 변수 치환 + ADF 테이블 재생성 → Epic description PUT 요청

---

## Feature #2: 이미지 복사 시 버튼 제외

### 문제
CopyImageButton이 캡처 대상 영역(table-container) 내부에 렌더링되어, html2canvas 실행 시 버튼 텍스트("이미지 복사" 또는 "생성 중...")가 함께 캡처됨

### 해결
기존 `.copy-exclude` 클래스 메커니즘 활용.
CopyImageButton 래퍼에 `copy-exclude` 클래스 추가.

### 변경 파일
- `ScheduleTable.tsx`: CopyImageButton 래퍼에 `copy-exclude` 추가
- `CalendarView.tsx`: 동일
- `GanttChart.tsx`: 동일
- `useImageCopy.ts`: 변경 없음 (이미 .copy-exclude 처리 중)

---

## Feature #3: Epic Description 편집 UI

### UI 위치
ProjectEditModal에서 "Epic Summary 템플릿" 아래, "헤즈업 Task Summary 템플릿" 위:
```
Epic Summary 템플릿 (선택)        ← 기존, 라인 230
Epic Description 템플릿 (선택)    ← 신규
헤즈업 Task Summary 템플릿 (선택)  ← 기존, 라인 255
```

### UI 구성
- 라벨: `Epic Description 템플릿 (선택)`
- 입력: `<textarea>` (headsup description과 동일한 형태)
- placeholder: `Epic 일감의 설명에 삽입될 내용`
- 안내: 사용 가능한 변수 + ADF 테이블 마크업 지원 안내
- info 아이콘 (?): 호버 시 전체 변수 목록 표시

### 데이터
- DB: `jira_epic_description` (text, nullable)
- Type: `Project.jiraEpicDescription?: string`

### 사용 흐름
1. 사용자가 설정에서 템플릿 작성 (변수 + ADF 마크업)
2. JIRA 생성 시 useJiraOperations에서 변수 치환
3. Edge Function으로 전달 → `textToADF()` 변환 → Epic description 필드에 삽입

---

## Feature #4: 변수 체계 통합

### 통합 변수 테이블

날짜 변수 (4 날짜 × 3 형식 = 12개):

| Base | {base} (MMDD) | {baseDay} (MM/DD(요일)) | {baseFull} (YY/MM/DD) |
|------|---------------|------------------------|----------------------|
| updateDate | 0210 | 02/10(월) | 26/02/10 |
| headsUp | 0128 | 01/28(화) | 26/01/28 |
| iosReviewDate | 0203 | 02/03(화) | 26/02/03 |
| paidProductDate | 0301 | 03/01(수) | 26/03/01 |

레거시 (하위 호환 1개):
- `{date}` → YYMMDD (260210)

폐기:
- `{updateDateShort}` → `{updateDate}`로 대체

Breaking change:
- `{headsUp}` 이메일 쪽: MM/DD(요일) → MMDD로 변경 (기존 이메일 템플릿은 `{headsUpDay}`로 수정 필요)

비날짜 변수 (변경 없음):
- 공통: `{projectName}`
- JIRA 전용: `{taskName}`, `{subtaskName}`, `{stageName}`
- 이메일 전용: `{table}`, `{disclaimer}`, `{showIosReviewDate}`, `{showPaidProductDate}`

### 구현 범위
- `src/lib/jira/templates.ts`: TemplateVars 확장, applyTemplate() 새 변수, formatDateYYSlash() 신규
- `src/lib/email/emailGenerator.ts`: TemplateContext에 새 변수 추가
- `src/lib/email/formatters.ts`: formatDateMMDD() 활용, formatDateYYSlash() 추가
- `src/types/index.ts`: VALID_TEMPLATE_VARIABLES 배열 갱신
- `src/hooks/useJiraOperations.ts`: 새 변수를 TemplateVars에 전달

---

## Feature #5: user-manual.html 최신화

- 이메일 템플릿 변수 테이블 갱신 (통합된 12개 + 레거시)
- Epic Description 편집/표 삽입 기능 안내 추가
- 기존 문서/코드 불일치 수정 (updateDate, updateDateShort 표기)
- JIRA 설정 섹션에 새 옵션 안내 추가
